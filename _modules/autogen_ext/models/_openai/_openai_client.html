<!DOCTYPE html>
<html lang="en"
      data-content_root="../../../../"
      x-data="{ darkMode: localStorage.getItem('darkMode') || localStorage.setItem('darkMode', 'system'), activeSection: '' }"
      x-init="$watch('darkMode', val => localStorage.setItem('darkMode', val))"
      class="scroll-smooth"
      :class="{'dark': darkMode === 'dark' || (darkMode === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)}"
>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta charset="utf-8" />
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="white" />
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="black" />
  
    <title>autogen_ext.models._openai._openai_client | AutoGen</title>
    <meta property="og:title" content="autogen_ext.models._openai._openai_client | AutoGen" />
    <meta name="twitter:title" content="autogen_ext.models._openai._openai_client | AutoGen" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=3d3fbe02" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/theme.css?v=42baaae4" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx-design.min.css?v=95c83b7e" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/custom.css?v=ebe0eec8" />
      <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/awesome-sphinx-design.css?v=15e0fffa" />
    <link rel="canonical" href="/autogen/dev/_modules/autogen_ext/models/_openai/_openai_client.html" />
      <link rel="icon" href="../../../../_static/favicon-512x512.png" />
        <link rel="search" title="Search" href="../../../../search.html" />
        <link rel="index" title="Index" href="../../../../genindex.html" />

    <script>
    <!-- Prevent Flash of wrong theme -->
      const userPreference = localStorage.getItem('darkMode');
      let mode;
      if (userPreference === 'dark' || window.matchMedia('(prefers-color-scheme: dark)').matches) {
        mode = 'dark';
        document.documentElement.classList.add('dark');
      } else {
        mode = 'light';
      }
      if (!userPreference) {localStorage.setItem('darkMode', mode)}
     
      function closeAnnouncement() {
          var announcementBar = document.getElementById('announcementBar');
          if (announcementBar) {
              announcementBar.style.animation = 'fadeOut 0.5s ease forwards';
              setTimeout(() => {
                  announcementBar.remove();
              }, 500);
          }
      }
    </script>
</head>
  <body x-data="{ showSidebar: false, showScrollTop: false }" class="min-h-screen font-sans antialiased bg-background text-foreground" :class="{ 'overflow-hidden': showSidebar }">
    <div x-cloak x-show="showSidebar" class="fixed inset-0 z-50 overflow-hidden bg-background/80 backdrop-blur-sm md:hidden" @click.self="showSidebar = false"></div><div id="page" class="relative flex flex-col min-h-screen">
    
    
    <div id="announcementBar" class="announcementbar">
      <div class="announcementbar-content">
        <div class="announcementbar-message"><span class="fa-solid fa-triangle-exclamation"></span> AutoGen v0.4 is a work in progress. Go <a href="https://microsoft.github.io/autogen/0.2/">here</a> to continue using v0.2 documentation.</div>
        <button class="announcement-close-button" onclick="closeAnnouncement()">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <a href="#content" class="absolute top-0 left-0 z-[100] block bg-background p-4 text-xl transition -translate-x-full opacity-0 focus:translate-x-0 focus:opacity-100">
      Skip to content
    </a><header
  class="sticky top-0 z-40 w-full border-b shadow-sm border-border supports-backdrop-blur:bg-background/60 bg-background/95 backdrop-blur"><div class="container flex items-center h-14">
    <div class="hidden mr-4 md:flex">
      <a href="../../../../index.html" class="flex items-center mr-6">
          <img height="24" width="24" class="mr-2 dark:invert" src="../../../../_static/logo.svg" alt="Logo" /><span class="hidden font-bold sm:inline-block text-clip whitespace-nowrap">AutoGen</span>
      </a><nav class="flex items-center space-x-6 text-sm font-medium">
        <a href="/index.html" class="transition-colors hover:text-foreground/80 text-foreground/60">Docs</a>
      </nav></div><button
      class="inline-flex items-center justify-center h-10 px-0 py-2 mr-2 text-base font-medium transition-colors rounded-md hover:text-accent-foreground hover:bg-transparent md:hidden"
      type="button" @click="showSidebar = true">
      <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 96 960 960" aria-hidden="true"
        fill="currentColor">
        <path
          d="M152.587 825.087q-19.152 0-32.326-13.174t-13.174-32.326q0-19.152 13.174-32.326t32.326-13.174h440q19.152 0 32.326 13.174t13.174 32.326q0 19.152-13.174 32.326t-32.326 13.174h-440Zm0-203.587q-19.152 0-32.326-13.174T107.087 576q0-19.152 13.174-32.326t32.326-13.174h320q19.152 0 32.326 13.174T518.087 576q0 19.152-13.174 32.326T472.587 621.5h-320Zm0-203.587q-19.152 0-32.326-13.174t-13.174-32.326q0-19.152 13.174-32.326t32.326-13.174h440q19.152 0 32.326 13.174t13.174 32.326q0 19.152-13.174 32.326t-32.326 13.174h-440ZM708.913 576l112.174 112.174q12.674 12.674 12.674 31.826t-12.674 31.826Q808.413 764.5 789.261 764.5t-31.826-12.674l-144-144Q600 594.391 600 576t13.435-31.826l144-144q12.674-12.674 31.826-12.674t31.826 12.674q12.674 12.674 12.674 31.826t-12.674 31.826L708.913 576Z" />
      </svg>
      <span class="sr-only">Toggle navigation menu</span>
    </button>
    <div class="flex items-center justify-between flex-1 space-x-2 sm:space-x-4 md:justify-end">
      <div class="flex-1 w-full md:w-auto md:flex-none"><form id="searchbox"
      action="../../../../search.html"
      method="get"
      class="relative flex items-center group"
      @keydown.k.window.meta="$refs.search.focus()">
  <input x-ref="search"
          name="q"
          id="search-input"
          type="search"
          aria-label="Search the docs"
          placeholder="Search ..."
          class="inline-flex items-center font-medium transition-colors bg-transparent focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 ring-offset-background border border-input hover:bg-accent focus:bg-accent hover:text-accent-foreground focus:text-accent-foreground hover:placeholder-accent-foreground py-2 px-4 relative h-9 w-full justify-start rounded-[0.5rem] text-sm text-muted-foreground sm:pr-12 md:w-40 lg:w-64" />
  <kbd class="pointer-events-none absolute right-1.5 top-2 hidden h-5 select-none text-muted-foreground items-center gap-1 rounded border border-border bg-muted px-1.5 font-mono text-[10px] font-medium opacity-100 sm:flex group-hover:bg-accent group-hover:text-accent-foreground">
    <span class="text-xs">âŒ˜</span>
    K
  </kbd>
</form>
      </div>
      <nav class="flex items-center space-x-1">
        <a href="https://twitter.com/pyautogen" title="Visit Twitter" rel="noopener nofollow">
          <div
            class="inline-flex items-center justify-center px-0 text-sm font-medium transition-colors rounded-md disabled:opacity-50 disabled:pointer-events-none hover:bg-accent hover:text-accent-foreground h-9 w-9">
            <svg height="22px" style="margin-top:-2px;display:inline" viewBox="0 0 512 512" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
          </div>
        </a>
        
        <a href="https://github.com/microsoft/agnext" title="Visit GitHub" rel="noopener nofollow">
          <div
            class="inline-flex items-center justify-center px-0 text-sm font-medium transition-colors rounded-md disabled:opacity-50 disabled:pointer-events-none hover:bg-accent hover:text-accent-foreground h-9 w-9">
            <svg height="22px" style="margin-top:-2px;display:inline" viewBox="0 0 45 44" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M22.477.927C10.485.927.76 10.65.76 22.647c0 9.596 6.223 17.736 14.853 20.608 1.087.2 1.483-.47 1.483-1.047 0-.516-.019-1.881-.03-3.693-6.04 1.312-7.315-2.912-7.315-2.912-.988-2.51-2.412-3.178-2.412-3.178-1.972-1.346.149-1.32.149-1.32 2.18.154 3.327 2.24 3.327 2.24 1.937 3.318 5.084 2.36 6.321 1.803.197-1.403.759-2.36 1.379-2.903-4.823-.548-9.894-2.412-9.894-10.734 0-2.37.847-4.31 2.236-5.828-.224-.55-.969-2.759.214-5.748 0 0 1.822-.584 5.972 2.226 1.732-.482 3.59-.722 5.437-.732 1.845.01 3.703.25 5.437.732 4.147-2.81 5.967-2.226 5.967-2.226 1.185 2.99.44 5.198.217 5.748 1.392 1.517 2.232 3.457 2.232 5.828 0 8.344-5.078 10.18-9.916 10.717.779.67 1.474 1.996 1.474 4.021 0 2.904-.027 5.247-.027 5.96 0 .58.392 1.256 1.493 1.044C37.981 40.375 44.2 32.24 44.2 22.647c0-11.996-9.726-21.72-21.722-21.72" fill="currentColor"/></svg>
          </div>
        </a>
        
        <a href="/packages" title="Visit Packages" rel="noopener nofollow">
          <div
            class="inline-flex items-center justify-center px-0 text-sm font-medium transition-colors rounded-md disabled:opacity-50 disabled:pointer-events-none hover:bg-accent hover:text-accent-foreground h-9 w-9">
            <svg width="22" height="20" viewBox="0 0 118 105" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.6645 40.4581L34.2565 46.4975L51.0948 40.3685L34.5029 34.329L17.6645 40.4581ZM34.329 26.8229L50.922 32.8623L67.7593 26.7333L51.1674 20.6938L34.329 26.8229Z" fill="#F7F7F4" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M34.329 26.8229L50.922 32.8624V52.3631L34.329 46.3247V26.8229Z" fill="#EFEEEA" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M1 66.2116L17.592 72.2521L34.4303 66.1231L17.8373 60.0836L1 66.2116Z" fill="#F7F7F4" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M1 66.2117L17.592 72.2522V91.753L1 85.7146V66.2117Z" fill="#EFEEEA" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M1 38.4783L17.592 44.5189L34.4303 38.3898L17.8373 32.3503L1 38.4783Z" fill="#F7F7F4" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M17.5919 44.5189V64.0196L34.4303 57.8916V38.3898L17.5919 44.5189Z" fill="white" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M1 38.4783L17.592 44.5189V64.0196L1 57.9812V38.4783Z" fill="#EFEEEA" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M17.6634 72.2725L34.2564 78.3119V97.8137L17.6645 91.7743L17.6634 72.2725Z" fill="#EFEEEA" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M17.6634 52.5775L34.2564 58.617L51.0948 52.4879L34.5028 46.4495L17.6634 52.5775Z" fill="#F7F7F4" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M17.6634 52.5775L34.2564 58.617V78.1188L17.6645 72.0794L17.6634 52.5775Z" fill="#EFEEEA" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M100.917 66.1913V85.6932L117.754 79.5652V60.0634L100.917 66.1913Z" fill="white" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M84.251 72.2521V91.7529L101.089 85.6249V66.123L84.251 72.2521Z" fill="#FFD242" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M98.0377 77.0062C98.0378 77.4582 97.9542 77.9362 97.7917 78.413C97.6292 78.8897 97.391 79.3559 97.0907 79.7848C96.7904 80.2137 96.4338 80.5969 96.0414 80.9127C95.6489 81.2284 95.2283 81.4704 94.8036 81.6249C93.9463 81.9367 93.1241 81.8734 92.5178 81.4489C91.9116 81.0245 91.5708 80.2736 91.5705 79.3614C91.5703 78.9095 91.6539 78.4316 91.8163 77.9549C91.9787 77.4782 92.2168 77.0121 92.517 76.5832C92.8172 76.1543 93.1737 75.771 93.566 75.4552C93.9583 75.1394 94.3789 74.8973 94.8036 74.7428C95.2283 74.5882 95.6488 74.5241 96.0412 74.5542C96.4336 74.5844 96.7901 74.7081 97.0904 74.9184C97.3908 75.1287 97.629 75.4214 97.7915 75.7798C97.9541 76.1382 98.0377 76.5543 98.0377 77.0062Z" fill="white"/><path d="M67.5865 78.3119V97.8137L84.4249 91.6847V72.1829L67.5865 78.3119Z" fill="#FFD242" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M50.922 84.3717V103.873L67.7593 97.7444V78.2437L50.922 84.3717Z" fill="white" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M34.329 78.3322L50.922 84.3716V103.873L34.329 97.834V78.3322Z" fill="#EFEEEA" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M100.917 46.4975V65.9983L117.754 59.8703V40.3685L100.917 46.4975Z" fill="#FFD242" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M84.3235 20.7632L100.917 26.8026L117.754 20.6736L101.162 14.6341L84.3235 20.7632Z" fill="#FFC91D" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M100.917 26.8026V46.3034L117.754 40.1754V20.6736L100.917 26.8026ZM84.251 52.5572V72.058L101.089 65.93V46.4282L84.251 52.5572Z" fill="#FFD242" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M84.251 32.8624V52.3631L101.089 46.2351V26.7333L84.251 32.8624Z" fill="#3775A9" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M67.6591 7.12799L84.251 13.1674L101.089 7.03839L84.4974 1L67.6591 7.12799Z" fill="#2F6491" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M84.251 13.1664V32.6682L101.089 26.5402V7.03839L84.251 13.1664Z" fill="#3775A9" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M67.5865 58.617V78.1188L84.4249 71.9898V52.4879L67.5865 58.617Z" fill="#FFD242" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M67.5865 38.9221V58.4239L84.4249 52.2948V32.793L67.5865 38.9221ZM50.922 64.6767V84.1785L67.7593 78.0495V58.5487L50.922 64.6767Z" fill="#3775A9" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M34.329 58.6383L50.922 64.6767V84.1786L34.329 78.1391V58.6383ZM34.329 38.9424L50.922 44.9818L67.7593 38.8538L51.1674 32.8144L34.329 38.9424Z" fill="#2F6491" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M50.922 44.9818V64.4836L67.7593 58.3546V38.8538L50.922 44.9818Z" fill="#3775A9" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M34.329 38.9423L50.922 44.9818V64.4836L34.329 58.4442V38.9423ZM50.9946 13.1877L67.5865 19.2272L84.4249 13.0981L67.8319 7.05972L50.9946 13.1877Z" fill="#2F6491" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M67.5865 19.2272V38.729L84.4249 32.5999V13.0981L67.5865 19.2272Z" fill="#3775A9" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M50.9946 13.1877L67.5865 19.2272V38.729L50.9946 32.6895V13.1877Z" fill="#2F6491" stroke="#CCCCCC" stroke-width="0.378666" stroke-linejoin="bevel"/><path d="M77.1065 25.4906C77.1066 25.9426 77.023 26.4206 76.8605 26.8974C76.6981 27.3741 76.4598 27.8403 76.1595 28.2692C75.8592 28.6981 75.5026 29.0813 75.1102 29.3971C74.7177 29.7128 74.2971 29.9548 73.8724 30.1093C73.4477 30.2639 73.0271 30.3279 72.6347 30.2978C72.2424 30.2677 71.8858 30.1439 71.5855 29.9336C71.2852 29.7233 71.0469 29.4306 70.8844 29.0722C70.7219 28.7138 70.6382 28.2967 70.6382 27.8448C70.6381 27.3928 70.7217 26.9148 70.8842 26.438C71.0467 25.9613 71.2849 25.4951 71.5853 25.0662C71.8856 24.6373 72.2422 24.254 72.6346 23.9383C73.027 23.6226 73.4476 23.3806 73.8724 23.2261C74.2971 23.0715 74.7176 23.0074 75.11 23.0376C75.5024 23.0677 75.8589 23.1915 76.1593 23.4018C76.4596 23.612 76.6978 23.9047 76.8603 24.2632C77.0229 24.6216 77.1065 25.0387 77.1065 25.4906Z" fill="white"/></svg>
          </div>
        </a>
        
        <button @click="darkMode = darkMode === 'light' ? 'dark' : 'light'"
          class="relative inline-flex items-center justify-center px-0 text-sm font-medium transition-colors rounded-md hover:bg-accent hover:text-accent-foreground h-9 w-9"
          type="button"
          aria-label="Color theme switcher">
          <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 96 960 960" fill="currentColor"
            class="absolute transition-all scale-100 rotate-0 dark:-rotate-90 dark:scale-0">
            <path
              d="M480 685q45.456 0 77.228-31.772Q589 621.456 589 576q0-45.456-31.772-77.228Q525.456 467 480 467q-45.456 0-77.228 31.772Q371 530.544 371 576q0 45.456 31.772 77.228Q434.544 685 480 685Zm0 91q-83 0-141.5-58.5T280 576q0-83 58.5-141.5T480 376q83 0 141.5 58.5T680 576q0 83-58.5 141.5T480 776ZM80 621.5q-19.152 0-32.326-13.174T34.5 576q0-19.152 13.174-32.326T80 530.5h80q19.152 0 32.326 13.174T205.5 576q0 19.152-13.174 32.326T160 621.5H80Zm720 0q-19.152 0-32.326-13.174T754.5 576q0-19.152 13.174-32.326T800 530.5h80q19.152 0 32.326 13.174T925.5 576q0 19.152-13.174 32.326T880 621.5h-80Zm-320-320q-19.152 0-32.326-13.174T434.5 256v-80q0-19.152 13.174-32.326T480 130.5q19.152 0 32.326 13.174T525.5 176v80q0 19.152-13.174 32.326T480 301.5Zm0 720q-19.152 0-32.326-13.17Q434.5 995.152 434.5 976v-80q0-19.152 13.174-32.326T480 850.5q19.152 0 32.326 13.174T525.5 896v80q0 19.152-13.174 32.33-13.174 13.17-32.326 13.17ZM222.174 382.065l-43-42Q165.5 327.391 166 308.239t13.174-33.065q13.435-13.674 32.587-13.674t32.065 13.674l42.239 43q12.674 13.435 12.555 31.706-.12 18.272-12.555 31.946-12.674 13.674-31.445 13.413-18.772-.261-32.446-13.174Zm494 494.761-42.239-43q-12.674-13.435-12.674-32.087t12.674-31.565Q686.609 756.5 705.38 757q18.772.5 32.446 13.174l43 41.761Q794.5 824.609 794 843.761t-13.174 33.065Q767.391 890.5 748.239 890.5t-32.065-13.674Zm-42-494.761Q660.5 369.391 661 350.62q.5-18.772 13.174-32.446l41.761-43Q728.609 261.5 747.761 262t33.065 13.174q13.674 13.435 13.674 32.587t-13.674 32.065l-43 42.239q-13.435 12.674-31.706 12.555-18.272-.12-31.946-12.555Zm-495 494.761Q165.5 863.391 165.5 844.239t13.674-32.065l43-42.239q13.435-12.674 32.087-12.674t31.565 12.674Q299.5 782.609 299 801.38q-.5 18.772-13.174 32.446l-41.761 43Q231.391 890.5 212.239 890t-33.065-13.174ZM480 576Z" />
          </svg>
          <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 96 960 960" fill="currentColor"
            class="absolute transition-all scale-0 rotate-90 dark:rotate-0 dark:scale-100">
            <path
              d="M480 936q-151 0-255.5-104.5T120 576q0-138 90-239.5T440 218q25-3 39 18t-1 44q-17 26-25.5 55t-8.5 61q0 90 63 153t153 63q31 0 61.5-9t54.5-25q21-14 43-1.5t19 39.5q-14 138-117.5 229T480 936Zm0-80q88 0 158-48.5T740 681q-20 5-40 8t-40 3q-123 0-209.5-86.5T364 396q0-20 3-40t8-40q-78 32-126.5 102T200 576q0 116 82 198t198 82Zm-10-270Z" />
          </svg>
        </button>
      </nav>
    </div>
  </div>
</header>

    <div class="flex-1"><div class="container flex-1 items-start md:grid md:grid-cols-[220px_minmax(0,1fr)] md:gap-6 lg:grid-cols-[240px_minmax(0,1fr)] lg:gap-10"><aside id="left-sidebar"
  class="fixed inset-y-0 left-0 md:top-14 z-50 md:z-30 bg-background md:bg-transparent transition-all duration-100 -translate-x-full md:translate-x-0 ml-0 p-6 md:p-0 md:-ml-2 md:h-[calc(100vh-3.5rem)] w-5/6 md:w-full shrink-0 overflow-y-auto border-r border-border md:sticky"
  :aria-hidden="!showSidebar" :class="{ 'translate-x-0': showSidebar }">

    <a href="../../../../index.html" class="!justify-start text-sm md:!hidden bg-background">
        <img height="16" width="16" class="mr-2 dark:invert" src="../../../../_static/logo.svg" alt="Logo" /><span class="font-bold text-clip whitespace-nowrap">AutoGen</span>
    </a>

    <div class="relative overflow-hidden md:overflow-auto my-4 md:my-0 h-[calc(100vh-8rem)] md:h-auto">
      <div class="overflow-y-auto h-full w-full relative pr-6"><nav class="flex md:hidden flex-col font-medium mt-4">
  <a href="/index.html">Docs</a>
</nav><nav class="table w-full min-w-full my-6 lg:my-8">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../user-guide/agentchat-user-guide/index.html">AgentChat</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../user-guide/agentchat-user-guide/installation.html">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user-guide/agentchat-user-guide/quickstart.html">Quickstart</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user-guide/agentchat-user-guide/tutorial/index.html">Tutorial</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/agentchat-user-guide/tutorial/models.html">Models</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/agentchat-user-guide/tutorial/agents.html">Agents</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/agentchat-user-guide/tutorial/teams.html">Teams</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/agentchat-user-guide/tutorial/selector-group-chat.html">Selector Group Chat</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/agentchat-user-guide/tutorial/swarm.html">Swarm</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/agentchat-user-guide/tutorial/termination.html">Termination</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/agentchat-user-guide/tutorial/termination.html#autogen-provides-several-built-in-termination-conditions">AutoGen provides several built-in termination conditions:</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/agentchat-user-guide/tutorial/custom-agents.html">Custom Agents</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user-guide/agentchat-user-guide/examples/index.html">Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/agentchat-user-guide/examples/travel-planning.html">Travel Planning</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/agentchat-user-guide/examples/company-research.html">Company Research</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/agentchat-user-guide/examples/literature-review.html">Literature Review</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../user-guide/core-user-guide/index.html">Core</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../user-guide/core-user-guide/quickstart.html">Quick Start</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user-guide/core-user-guide/core-concepts/index.html">Core Concepts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/core-concepts/agent-and-multi-agent-application.html">Agent and Multi-Agent Applications</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/core-concepts/architecture.html">Agent Runtime Environments</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/core-concepts/api-layers.html">API Layers</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/core-concepts/application-stack.html">Application Stack</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/core-concepts/agent-identity-and-lifecycle.html">Agent Identity and Lifecycle</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/core-concepts/topic-and-subscription.html">Topic and Subscription</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user-guide/core-user-guide/framework/index.html">Framework Guide</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/framework/agent-and-agent-runtime.html">Agent and Agent Runtime</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/framework/message-and-communication.html">Message and Communication</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/framework/model-clients.html">Model Clients</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/framework/tools.html">Tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/framework/logging.html">Logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/framework/telemetry.html">Open Telemetry</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/framework/command-line-code-executors.html">Command Line Code Executors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/framework/distributed-agent-runtime.html">Distributed Agent Runtime</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/framework/distributed-agent-runtime.html#next-steps">Next Steps</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user-guide/core-user-guide/design-patterns/index.html">Multi-Agent Design Patterns</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/design-patterns/group-chat.html">Group Chat</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/design-patterns/handoffs.html">Handoffs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/design-patterns/mixture-of-agents.html">Mixture of Agents</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/design-patterns/multi-agent-debate.html">Multi-Agent Debate</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/design-patterns/reflection.html">Reflection</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user-guide/core-user-guide/cookbook/index.html">Cookbook</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/cookbook/azure-openai-with-aad-auth.html">Azure OpenAI with AAD Auth</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/cookbook/termination-with-intervention.html">Termination using Intervention Handler</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/cookbook/tool-use-with-intervention.html">User Approval for Tool Execution using Intervention Handler</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/cookbook/extracting-results-with-an-agent.html">Extracting Results with an Agent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/cookbook/openai-assistant-agent.html">OpenAI Assistant Agent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/cookbook/langgraph-agent.html">Using LangGraph-Backed Agent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/cookbook/llamaindex-agent.html">Using LlamaIndex-Backed Agent</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/cookbook/local-llms-ollama-litellm.html">Local LLMs with LiteLLM &amp; Ollama</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/cookbook/instrumenting.html">Instrumentating your code locally</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/cookbook/topic-subscription-scenarios.html">Topic and Subscription Example Scenarios</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../user-guide/core-user-guide/cookbook/structured-output-agent.html">Structured output using GPT-4o models</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../user-guide/core-user-guide/faqs.html">FAQs</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../user-guide/extensions-user-guide/index.html">Extensions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../user-guide/extensions-user-guide/azure-container-code-executor.html">ACA Dynamic Sessions Code Executor</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../packages/index.html">Packages</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../reference/python/autogen_agentchat/autogen_agentchat.html">autogen_agentchat</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../reference/python/autogen_agentchat/autogen_agentchat.agents.html">autogen_agentchat.agents</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../reference/python/autogen_agentchat/autogen_agentchat.base.html">autogen_agentchat.base</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../reference/python/autogen_agentchat/autogen_agentchat.logging.html">autogen_agentchat.logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../reference/python/autogen_agentchat/autogen_agentchat.task.html">autogen_agentchat.task</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../reference/python/autogen_agentchat/autogen_agentchat.teams.html">autogen_agentchat.teams</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../reference/python/autogen_agentchat/autogen_agentchat.messages.html">autogen_agentchat.messages</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../reference/python/autogen_core/autogen_core.html">autogen_core</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../reference/python/autogen_core/autogen_core.application.html">autogen_core.application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../reference/python/autogen_core/autogen_core.base.html">autogen_core.base</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../reference/python/autogen_core/autogen_core.components.html">autogen_core.components</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../reference/python/autogen_ext/autogen_ext.html">autogen_ext</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../reference/python/autogen_ext/autogen_ext.agents.html">autogen_ext.agents</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../reference/python/autogen_ext/autogen_ext.code_executors.html">autogen_ext.code_executors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../reference/python/autogen_ext/autogen_ext.models.html">autogen_ext.models</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../reference/python/autogen_ext/autogen_ext.tools.html">autogen_ext.tools</a></li>
</ul>
</li>
</ul>
</li>
</ul>

</nav>
      </div>
    </div>
    <button type="button" @click="showSidebar = false"
      class="absolute md:hidden right-4 top-4 rounded-sm opacity-70 transition-opacity hover:opacity-100">
      <svg xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 96 960 960" fill="currentColor"
        stroke="none" class="h-4 w-4">
        <path
          d="M480 632 284 828q-11 11-28 11t-28-11q-11-11-11-28t11-28l196-196-196-196q-11-11-11-28t11-28q11-11 28-11t28 11l196 196 196-196q11-11 28-11t28 11q11 11 11 28t-11 28L536 576l196 196q11 11 11 28t-11 28q-11 11-28 11t-28-11L480 632Z" />
      </svg>
    </button>
  </aside>
        <main class="relative py-6 lg:gap-10 lg:py-8 xl:grid xl:grid-cols-[1fr_300px]">
<div class="w-full min-w-0 mx-auto">
<nav aria-label="breadcrumbs"
     class="flex items-center mb-4 space-x-1 text-sm text-muted-foreground">
  <a class="overflow-hidden text-ellipsis whitespace-nowrap hover:text-foreground"
     href="../../../../index.html">
    <span class="hidden md:inline">AutoGen</span>
    <svg xmlns="http://www.w3.org/2000/svg"
         height="18"
         width="18"
         viewBox="0 96 960 960"
         aria-label="Home"
         fill="currentColor"
         stroke="none"
         class="md:hidden">
      <path d="M240 856h120V616h240v240h120V496L480 316 240 496v360Zm-80 80V456l320-240 320 240v480H520V696h-80v240H160Zm320-350Z" />
    </svg>
  </a>
  
<div class="mr-1">/</div><a class="hover:text-foreground overflow-hidden text-ellipsis whitespace-nowrap"
       href="../../../index.html">Module code</a>
    
<div class="mr-1">/</div><span aria-current="page"
        class="font-medium text-foreground overflow-hidden text-ellipsis whitespace-nowrap">autogen_ext.models._openai._openai_client</span>
</nav>

    <div id="content" role="main">
      <h1>Source code for autogen_ext.models._openai._openai_client</h1><div class="highlight"><pre>
<span></span><code><span id="line-1"><span class="kn">import</span> <span class="nn">asyncio</span>
</span><span id="line-2"><span class="kn">import</span> <span class="nn">inspect</span>
</span><span id="line-3"><span class="kn">import</span> <span class="nn">json</span>
</span><span id="line-4"><span class="kn">import</span> <span class="nn">logging</span>
</span><span id="line-5"><span class="kn">import</span> <span class="nn">math</span>
</span><span id="line-6"><span class="kn">import</span> <span class="nn">re</span>
</span><span id="line-7"><span class="kn">import</span> <span class="nn">warnings</span>
</span><span id="line-8"><span class="kn">from</span> <span class="nn">asyncio</span> <span class="kn">import</span> <span class="n">Task</span>
</span><span id="line-9"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="line-10">    <span class="n">Any</span><span class="p">,</span>
</span><span id="line-11">    <span class="n">AsyncGenerator</span><span class="p">,</span>
</span><span id="line-12">    <span class="n">Dict</span><span class="p">,</span>
</span><span id="line-13">    <span class="n">List</span><span class="p">,</span>
</span><span id="line-14">    <span class="n">Mapping</span><span class="p">,</span>
</span><span id="line-15">    <span class="n">Optional</span><span class="p">,</span>
</span><span id="line-16">    <span class="n">Sequence</span><span class="p">,</span>
</span><span id="line-17">    <span class="n">Set</span><span class="p">,</span>
</span><span id="line-18">    <span class="n">Type</span><span class="p">,</span>
</span><span id="line-19">    <span class="n">Union</span><span class="p">,</span>
</span><span id="line-20">    <span class="n">cast</span><span class="p">,</span>
</span><span id="line-21"><span class="p">)</span>
</span><span id="line-22">
</span><span id="line-23"><span class="kn">import</span> <span class="nn">tiktoken</span>
</span><span id="line-24"><span class="kn">from</span> <span class="nn">autogen_core.application.logging</span> <span class="kn">import</span> <span class="n">EVENT_LOGGER_NAME</span><span class="p">,</span> <span class="n">TRACE_LOGGER_NAME</span>
</span><span id="line-25"><span class="kn">from</span> <span class="nn">autogen_core.application.logging.events</span> <span class="kn">import</span> <span class="n">LLMCallEvent</span>
</span><span id="line-26"><span class="kn">from</span> <span class="nn">autogen_core.base</span> <span class="kn">import</span> <span class="n">CancellationToken</span>
</span><span id="line-27"><span class="kn">from</span> <span class="nn">autogen_core.components</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="line-28">    <span class="n">FunctionCall</span><span class="p">,</span>
</span><span id="line-29">    <span class="n">Image</span><span class="p">,</span>
</span><span id="line-30"><span class="p">)</span>
</span><span id="line-31"><span class="kn">from</span> <span class="nn">autogen_core.components.models</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="line-32">    <span class="n">AssistantMessage</span><span class="p">,</span>
</span><span id="line-33">    <span class="n">ChatCompletionClient</span><span class="p">,</span>
</span><span id="line-34">    <span class="n">ChatCompletionTokenLogprob</span><span class="p">,</span>
</span><span id="line-35">    <span class="n">CreateResult</span><span class="p">,</span>
</span><span id="line-36">    <span class="n">FunctionExecutionResultMessage</span><span class="p">,</span>
</span><span id="line-37">    <span class="n">LLMMessage</span><span class="p">,</span>
</span><span id="line-38">    <span class="n">ModelCapabilities</span><span class="p">,</span>
</span><span id="line-39">    <span class="n">RequestUsage</span><span class="p">,</span>
</span><span id="line-40">    <span class="n">SystemMessage</span><span class="p">,</span>
</span><span id="line-41">    <span class="n">TopLogprob</span><span class="p">,</span>
</span><span id="line-42">    <span class="n">UserMessage</span><span class="p">,</span>
</span><span id="line-43"><span class="p">)</span>
</span><span id="line-44"><span class="kn">from</span> <span class="nn">autogen_core.components.tools</span> <span class="kn">import</span> <span class="n">Tool</span><span class="p">,</span> <span class="n">ToolSchema</span>
</span><span id="line-45"><span class="kn">from</span> <span class="nn">openai</span> <span class="kn">import</span> <span class="n">AsyncAzureOpenAI</span><span class="p">,</span> <span class="n">AsyncOpenAI</span>
</span><span id="line-46"><span class="kn">from</span> <span class="nn">openai.types.chat</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="line-47">    <span class="n">ChatCompletion</span><span class="p">,</span>
</span><span id="line-48">    <span class="n">ChatCompletionAssistantMessageParam</span><span class="p">,</span>
</span><span id="line-49">    <span class="n">ChatCompletionContentPartParam</span><span class="p">,</span>
</span><span id="line-50">    <span class="n">ChatCompletionContentPartTextParam</span><span class="p">,</span>
</span><span id="line-51">    <span class="n">ChatCompletionMessageParam</span><span class="p">,</span>
</span><span id="line-52">    <span class="n">ChatCompletionMessageToolCallParam</span><span class="p">,</span>
</span><span id="line-53">    <span class="n">ChatCompletionRole</span><span class="p">,</span>
</span><span id="line-54">    <span class="n">ChatCompletionSystemMessageParam</span><span class="p">,</span>
</span><span id="line-55">    <span class="n">ChatCompletionToolMessageParam</span><span class="p">,</span>
</span><span id="line-56">    <span class="n">ChatCompletionToolParam</span><span class="p">,</span>
</span><span id="line-57">    <span class="n">ChatCompletionUserMessageParam</span><span class="p">,</span>
</span><span id="line-58">    <span class="n">ParsedChatCompletion</span><span class="p">,</span>
</span><span id="line-59">    <span class="n">ParsedChoice</span><span class="p">,</span>
</span><span id="line-60">    <span class="n">completion_create_params</span><span class="p">,</span>
</span><span id="line-61"><span class="p">)</span>
</span><span id="line-62"><span class="kn">from</span> <span class="nn">openai.types.chat.chat_completion</span> <span class="kn">import</span> <span class="n">Choice</span>
</span><span id="line-63"><span class="kn">from</span> <span class="nn">openai.types.chat.chat_completion_chunk</span> <span class="kn">import</span> <span class="n">Choice</span> <span class="k">as</span> <span class="n">ChunkChoice</span>
</span><span id="line-64"><span class="kn">from</span> <span class="nn">openai.types.shared_params</span> <span class="kn">import</span> <span class="n">FunctionDefinition</span><span class="p">,</span> <span class="n">FunctionParameters</span>
</span><span id="line-65"><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
</span><span id="line-66"><span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Unpack</span>
</span><span id="line-67">
</span><span id="line-68"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_model_info</span>
</span><span id="line-69"><span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="n">AzureOpenAIClientConfiguration</span><span class="p">,</span> <span class="n">OpenAIClientConfiguration</span>
</span><span id="line-70">
</span><span id="line-71"><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">EVENT_LOGGER_NAME</span><span class="p">)</span>
</span><span id="line-72"><span class="n">trace_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">TRACE_LOGGER_NAME</span><span class="p">)</span>
</span><span id="line-73">
</span><span id="line-74"><span class="n">openai_init_kwargs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">AsyncOpenAI</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span><span class="o">.</span><span class="n">kwonlyargs</span><span class="p">)</span>
</span><span id="line-75"><span class="n">aopenai_init_kwargs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">AsyncAzureOpenAI</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span><span class="o">.</span><span class="n">kwonlyargs</span><span class="p">)</span>
</span><span id="line-76">
</span><span id="line-77"><span class="n">create_kwargs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">completion_create_params</span><span class="o">.</span><span class="n">CompletionCreateParamsBase</span><span class="o">.</span><span class="vm">__annotations__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span>
</span><span id="line-78">    <span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="s2">&quot;stream&quot;</span><span class="p">)</span>
</span><span id="line-79"><span class="p">)</span>
</span><span id="line-80"><span class="c1"># Only single choice allowed</span>
</span><span id="line-81"><span class="n">disallowed_create_args</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;stream&quot;</span><span class="p">,</span> <span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="s2">&quot;function_call&quot;</span><span class="p">,</span> <span class="s2">&quot;functions&quot;</span><span class="p">,</span> <span class="s2">&quot;n&quot;</span><span class="p">])</span>
</span><span id="line-82"><span class="n">required_create_args</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;model&quot;</span><span class="p">])</span>
</span><span id="line-83">
</span><span id="line-84">
</span><span id="line-85"><span class="k">def</span> <span class="nf">_azure_openai_client_from_config</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">AsyncAzureOpenAI</span><span class="p">:</span>
</span><span id="line-86">    <span class="c1"># Take a copy</span>
</span><span id="line-87">    <span class="n">copied_config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="line-88">
</span><span id="line-89">    <span class="kn">import</span> <span class="nn">warnings</span>
</span><span id="line-90">
</span><span id="line-91">    <span class="k">if</span> <span class="s2">&quot;azure_deployment&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">copied_config</span> <span class="ow">and</span> <span class="s2">&quot;model&quot;</span> <span class="ow">in</span> <span class="n">copied_config</span><span class="p">:</span>
</span><span id="line-92">        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span id="line-93">            <span class="s2">&quot;Previous behavior of using the model name as the deployment name is deprecated and will be removed in 0.4. Please specify azure_deployment&quot;</span><span class="p">,</span>
</span><span id="line-94">            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="line-95">        <span class="p">)</span>
</span><span id="line-96">
</span><span id="line-97">    <span class="k">if</span> <span class="s2">&quot;azure_endpoint&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">copied_config</span> <span class="ow">and</span> <span class="s2">&quot;base_url&quot;</span> <span class="ow">in</span> <span class="n">copied_config</span><span class="p">:</span>
</span><span id="line-98">        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span id="line-99">            <span class="s2">&quot;Previous behavior of using the base_url as the endpoint is deprecated and will be removed in 0.4. Please specify azure_endpoint&quot;</span><span class="p">,</span>
</span><span id="line-100">            <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="line-101">        <span class="p">)</span>
</span><span id="line-102">
</span><span id="line-103">    <span class="c1"># Do some fixups</span>
</span><span id="line-104">    <span class="n">copied_config</span><span class="p">[</span><span class="s2">&quot;azure_deployment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copied_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;azure_deployment&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">))</span>
</span><span id="line-105">    <span class="k">if</span> <span class="n">copied_config</span><span class="p">[</span><span class="s2">&quot;azure_deployment&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-106">        <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">copied_config</span><span class="p">[</span><span class="s2">&quot;azure_deployment&quot;</span><span class="p">]:</span>
</span><span id="line-107">            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span id="line-108">                <span class="s2">&quot;Previous behavior stripping &#39;.&#39; from the deployment name is deprecated and will be removed in 0.4&quot;</span><span class="p">,</span>
</span><span id="line-109">                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="line-110">            <span class="p">)</span>
</span><span id="line-111">            <span class="n">copied_config</span><span class="p">[</span><span class="s2">&quot;azure_deployment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copied_config</span><span class="p">[</span><span class="s2">&quot;azure_deployment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="line-112">    <span class="n">copied_config</span><span class="p">[</span><span class="s2">&quot;azure_endpoint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copied_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;azure_endpoint&quot;</span><span class="p">,</span> <span class="n">copied_config</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;base_url&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
</span><span id="line-113">
</span><span id="line-114">    <span class="c1"># Shave down the config to just the AzureOpenAIChatCompletionClient kwargs</span>
</span><span id="line-115">    <span class="n">azure_config</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">copied_config</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">aopenai_init_kwargs</span><span class="p">}</span>
</span><span id="line-116">    <span class="k">return</span> <span class="n">AsyncAzureOpenAI</span><span class="p">(</span><span class="o">**</span><span class="n">azure_config</span><span class="p">)</span>
</span><span id="line-117">
</span><span id="line-118">
</span><span id="line-119"><span class="k">def</span> <span class="nf">_openai_client_from_config</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">AsyncOpenAI</span><span class="p">:</span>
</span><span id="line-120">    <span class="c1"># Shave down the config to just the OpenAI kwargs</span>
</span><span id="line-121">    <span class="n">openai_config</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">openai_init_kwargs</span><span class="p">}</span>
</span><span id="line-122">    <span class="k">return</span> <span class="n">AsyncOpenAI</span><span class="p">(</span><span class="o">**</span><span class="n">openai_config</span><span class="p">)</span>
</span><span id="line-123">
</span><span id="line-124">
</span><span id="line-125"><span class="k">def</span> <span class="nf">_create_args_from_config</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="line-126">    <span class="n">create_args</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">create_kwargs</span><span class="p">}</span>
</span><span id="line-127">    <span class="n">create_args_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">create_args</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="line-128">    <span class="k">if</span> <span class="ow">not</span> <span class="n">required_create_args</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">create_args_keys</span><span class="p">):</span>
</span><span id="line-129">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Required create args are missing: </span><span class="si">{</span><span class="n">required_create_args</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">create_args_keys</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="line-130">    <span class="k">if</span> <span class="n">disallowed_create_args</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">create_args_keys</span><span class="p">):</span>
</span><span id="line-131">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Disallowed create args are present: </span><span class="si">{</span><span class="n">disallowed_create_args</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">create_args_keys</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="line-132">    <span class="k">return</span> <span class="n">create_args</span>
</span><span id="line-133">
</span><span id="line-134">
</span><span id="line-135"><span class="c1"># TODO check types</span>
</span><span id="line-136"><span class="c1"># oai_system_message_schema = type2schema(ChatCompletionSystemMessageParam)</span>
</span><span id="line-137"><span class="c1"># oai_user_message_schema = type2schema(ChatCompletionUserMessageParam)</span>
</span><span id="line-138"><span class="c1"># oai_assistant_message_schema = type2schema(ChatCompletionAssistantMessageParam)</span>
</span><span id="line-139"><span class="c1"># oai_tool_message_schema = type2schema(ChatCompletionToolMessageParam)</span>
</span><span id="line-140">
</span><span id="line-141">
</span><span id="line-142"><span class="k">def</span> <span class="nf">type_to_role</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">LLMMessage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatCompletionRole</span><span class="p">:</span>
</span><span id="line-143">    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">SystemMessage</span><span class="p">):</span>
</span><span id="line-144">        <span class="k">return</span> <span class="s2">&quot;system&quot;</span>
</span><span id="line-145">    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">UserMessage</span><span class="p">):</span>
</span><span id="line-146">        <span class="k">return</span> <span class="s2">&quot;user&quot;</span>
</span><span id="line-147">    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">AssistantMessage</span><span class="p">):</span>
</span><span id="line-148">        <span class="k">return</span> <span class="s2">&quot;assistant&quot;</span>
</span><span id="line-149">    <span class="k">else</span><span class="p">:</span>
</span><span id="line-150">        <span class="k">return</span> <span class="s2">&quot;tool&quot;</span>
</span><span id="line-151">
</span><span id="line-152">
</span><span id="line-153"><span class="k">def</span> <span class="nf">user_message_to_oai</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">UserMessage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatCompletionUserMessageParam</span><span class="p">:</span>
</span><span id="line-154">    <span class="n">assert_valid_name</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
</span><span id="line-155">    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="line-156">        <span class="k">return</span> <span class="n">ChatCompletionUserMessageParam</span><span class="p">(</span>
</span><span id="line-157">            <span class="n">content</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
</span><span id="line-158">            <span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
</span><span id="line-159">            <span class="n">name</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
</span><span id="line-160">        <span class="p">)</span>
</span><span id="line-161">    <span class="k">else</span><span class="p">:</span>
</span><span id="line-162">        <span class="n">parts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatCompletionContentPartParam</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-163">        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
</span><span id="line-164">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="line-165">                <span class="n">oai_part</span> <span class="o">=</span> <span class="n">ChatCompletionContentPartTextParam</span><span class="p">(</span>
</span><span id="line-166">                    <span class="n">text</span><span class="o">=</span><span class="n">part</span><span class="p">,</span>
</span><span id="line-167">                    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
</span><span id="line-168">                <span class="p">)</span>
</span><span id="line-169">                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oai_part</span><span class="p">)</span>
</span><span id="line-170">            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">Image</span><span class="p">):</span>
</span><span id="line-171">                <span class="c1"># TODO: support url based images</span>
</span><span id="line-172">                <span class="c1"># TODO: support specifying details</span>
</span><span id="line-173">                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">part</span><span class="o">.</span><span class="n">to_openai_format</span><span class="p">())</span>
</span><span id="line-174">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-175">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown content type: </span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="line-176">        <span class="k">return</span> <span class="n">ChatCompletionUserMessageParam</span><span class="p">(</span>
</span><span id="line-177">            <span class="n">content</span><span class="o">=</span><span class="n">parts</span><span class="p">,</span>
</span><span id="line-178">            <span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
</span><span id="line-179">            <span class="n">name</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
</span><span id="line-180">        <span class="p">)</span>
</span><span id="line-181">
</span><span id="line-182">
</span><span id="line-183"><span class="k">def</span> <span class="nf">system_message_to_oai</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">SystemMessage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatCompletionSystemMessageParam</span><span class="p">:</span>
</span><span id="line-184">    <span class="k">return</span> <span class="n">ChatCompletionSystemMessageParam</span><span class="p">(</span>
</span><span id="line-185">        <span class="n">content</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
</span><span id="line-186">        <span class="n">role</span><span class="o">=</span><span class="s2">&quot;system&quot;</span><span class="p">,</span>
</span><span id="line-187">    <span class="p">)</span>
</span><span id="line-188">
</span><span id="line-189">
</span><span id="line-190"><span class="k">def</span> <span class="nf">func_call_to_oai</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">FunctionCall</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatCompletionMessageToolCallParam</span><span class="p">:</span>
</span><span id="line-191">    <span class="k">return</span> <span class="n">ChatCompletionMessageToolCallParam</span><span class="p">(</span>
</span><span id="line-192">        <span class="nb">id</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="line-193">        <span class="n">function</span><span class="o">=</span><span class="p">{</span>
</span><span id="line-194">            <span class="s2">&quot;arguments&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">arguments</span><span class="p">,</span>
</span><span id="line-195">            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">message</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><span id="line-196">        <span class="p">},</span>
</span><span id="line-197">        <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">,</span>
</span><span id="line-198">    <span class="p">)</span>
</span><span id="line-199">
</span><span id="line-200">
</span><span id="line-201"><span class="k">def</span> <span class="nf">tool_message_to_oai</span><span class="p">(</span>
</span><span id="line-202">    <span class="n">message</span><span class="p">:</span> <span class="n">FunctionExecutionResultMessage</span><span class="p">,</span>
</span><span id="line-203"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ChatCompletionToolMessageParam</span><span class="p">]:</span>
</span><span id="line-204">    <span class="k">return</span> <span class="p">[</span>
</span><span id="line-205">        <span class="n">ChatCompletionToolMessageParam</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s2">&quot;tool&quot;</span><span class="p">,</span> <span class="n">tool_call_id</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">call_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span>
</span><span id="line-206">    <span class="p">]</span>
</span><span id="line-207">
</span><span id="line-208">
</span><span id="line-209"><span class="k">def</span> <span class="nf">assistant_message_to_oai</span><span class="p">(</span>
</span><span id="line-210">    <span class="n">message</span><span class="p">:</span> <span class="n">AssistantMessage</span><span class="p">,</span>
</span><span id="line-211"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ChatCompletionAssistantMessageParam</span><span class="p">:</span>
</span><span id="line-212">    <span class="n">assert_valid_name</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
</span><span id="line-213">    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="line-214">        <span class="k">return</span> <span class="n">ChatCompletionAssistantMessageParam</span><span class="p">(</span>
</span><span id="line-215">            <span class="n">tool_calls</span><span class="o">=</span><span class="p">[</span><span class="n">func_call_to_oai</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">],</span>
</span><span id="line-216">            <span class="n">role</span><span class="o">=</span><span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
</span><span id="line-217">            <span class="n">name</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
</span><span id="line-218">        <span class="p">)</span>
</span><span id="line-219">    <span class="k">else</span><span class="p">:</span>
</span><span id="line-220">        <span class="k">return</span> <span class="n">ChatCompletionAssistantMessageParam</span><span class="p">(</span>
</span><span id="line-221">            <span class="n">content</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">,</span>
</span><span id="line-222">            <span class="n">role</span><span class="o">=</span><span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
</span><span id="line-223">            <span class="n">name</span><span class="o">=</span><span class="n">message</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
</span><span id="line-224">        <span class="p">)</span>
</span><span id="line-225">
</span><span id="line-226">
</span><span id="line-227"><span class="k">def</span> <span class="nf">to_oai_type</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">LLMMessage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ChatCompletionMessageParam</span><span class="p">]:</span>
</span><span id="line-228">    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">SystemMessage</span><span class="p">):</span>
</span><span id="line-229">        <span class="k">return</span> <span class="p">[</span><span class="n">system_message_to_oai</span><span class="p">(</span><span class="n">message</span><span class="p">)]</span>
</span><span id="line-230">    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">UserMessage</span><span class="p">):</span>
</span><span id="line-231">        <span class="k">return</span> <span class="p">[</span><span class="n">user_message_to_oai</span><span class="p">(</span><span class="n">message</span><span class="p">)]</span>
</span><span id="line-232">    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">AssistantMessage</span><span class="p">):</span>
</span><span id="line-233">        <span class="k">return</span> <span class="p">[</span><span class="n">assistant_message_to_oai</span><span class="p">(</span><span class="n">message</span><span class="p">)]</span>
</span><span id="line-234">    <span class="k">else</span><span class="p">:</span>
</span><span id="line-235">        <span class="k">return</span> <span class="n">tool_message_to_oai</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span id="line-236">
</span><span id="line-237">
</span><span id="line-238"><span class="k">def</span> <span class="nf">calculate_vision_tokens</span><span class="p">(</span><span class="n">image</span><span class="p">:</span> <span class="n">Image</span><span class="p">,</span> <span class="n">detail</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="line-239">    <span class="n">MAX_LONG_EDGE</span> <span class="o">=</span> <span class="mi">2048</span>
</span><span id="line-240">    <span class="n">BASE_TOKEN_COUNT</span> <span class="o">=</span> <span class="mi">85</span>
</span><span id="line-241">    <span class="n">TOKENS_PER_TILE</span> <span class="o">=</span> <span class="mi">170</span>
</span><span id="line-242">    <span class="n">MAX_SHORT_EDGE</span> <span class="o">=</span> <span class="mi">768</span>
</span><span id="line-243">    <span class="n">TILE_SIZE</span> <span class="o">=</span> <span class="mi">512</span>
</span><span id="line-244">
</span><span id="line-245">    <span class="k">if</span> <span class="n">detail</span> <span class="o">==</span> <span class="s2">&quot;low&quot;</span><span class="p">:</span>
</span><span id="line-246">        <span class="k">return</span> <span class="n">BASE_TOKEN_COUNT</span>
</span><span id="line-247">
</span><span id="line-248">    <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">size</span>
</span><span id="line-249">
</span><span id="line-250">    <span class="c1"># Scale down to fit within a MAX_LONG_EDGE x MAX_LONG_EDGE square if necessary</span>
</span><span id="line-251">
</span><span id="line-252">    <span class="k">if</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="n">MAX_LONG_EDGE</span> <span class="ow">or</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="n">MAX_LONG_EDGE</span><span class="p">:</span>
</span><span id="line-253">        <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="n">height</span>
</span><span id="line-254">        <span class="k">if</span> <span class="n">aspect_ratio</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="line-255">            <span class="c1"># Width is greater than height</span>
</span><span id="line-256">            <span class="n">width</span> <span class="o">=</span> <span class="n">MAX_LONG_EDGE</span>
</span><span id="line-257">            <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">MAX_LONG_EDGE</span> <span class="o">/</span> <span class="n">aspect_ratio</span><span class="p">)</span>
</span><span id="line-258">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-259">            <span class="c1"># Height is greater than or equal to width</span>
</span><span id="line-260">            <span class="n">height</span> <span class="o">=</span> <span class="n">MAX_LONG_EDGE</span>
</span><span id="line-261">            <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">MAX_LONG_EDGE</span> <span class="o">*</span> <span class="n">aspect_ratio</span><span class="p">)</span>
</span><span id="line-262">
</span><span id="line-263">    <span class="c1"># Resize such that the shortest side is MAX_SHORT_EDGE if both dimensions exceed MAX_SHORT_EDGE</span>
</span><span id="line-264">    <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="n">height</span>
</span><span id="line-265">    <span class="k">if</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="n">MAX_SHORT_EDGE</span> <span class="ow">and</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="n">MAX_SHORT_EDGE</span><span class="p">:</span>
</span><span id="line-266">        <span class="k">if</span> <span class="n">aspect_ratio</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="line-267">            <span class="c1"># Width is greater than height</span>
</span><span id="line-268">            <span class="n">height</span> <span class="o">=</span> <span class="n">MAX_SHORT_EDGE</span>
</span><span id="line-269">            <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">MAX_SHORT_EDGE</span> <span class="o">*</span> <span class="n">aspect_ratio</span><span class="p">)</span>
</span><span id="line-270">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-271">            <span class="c1"># Height is greater than or equal to width</span>
</span><span id="line-272">            <span class="n">width</span> <span class="o">=</span> <span class="n">MAX_SHORT_EDGE</span>
</span><span id="line-273">            <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">MAX_SHORT_EDGE</span> <span class="o">/</span> <span class="n">aspect_ratio</span><span class="p">)</span>
</span><span id="line-274">
</span><span id="line-275">    <span class="c1"># Calculate the number of tiles based on TILE_SIZE</span>
</span><span id="line-276">
</span><span id="line-277">    <span class="n">tiles_width</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="n">TILE_SIZE</span><span class="p">)</span>
</span><span id="line-278">    <span class="n">tiles_height</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="n">TILE_SIZE</span><span class="p">)</span>
</span><span id="line-279">    <span class="n">total_tiles</span> <span class="o">=</span> <span class="n">tiles_width</span> <span class="o">*</span> <span class="n">tiles_height</span>
</span><span id="line-280">    <span class="c1"># Calculate the total tokens based on the number of tiles and the base token count</span>
</span><span id="line-281">
</span><span id="line-282">    <span class="n">total_tokens</span> <span class="o">=</span> <span class="n">BASE_TOKEN_COUNT</span> <span class="o">+</span> <span class="n">TOKENS_PER_TILE</span> <span class="o">*</span> <span class="n">total_tiles</span>
</span><span id="line-283">
</span><span id="line-284">    <span class="k">return</span> <span class="n">total_tokens</span>
</span><span id="line-285">
</span><span id="line-286">
</span><span id="line-287"><span class="k">def</span> <span class="nf">_add_usage</span><span class="p">(</span><span class="n">usage1</span><span class="p">:</span> <span class="n">RequestUsage</span><span class="p">,</span> <span class="n">usage2</span><span class="p">:</span> <span class="n">RequestUsage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RequestUsage</span><span class="p">:</span>
</span><span id="line-288">    <span class="k">return</span> <span class="n">RequestUsage</span><span class="p">(</span>
</span><span id="line-289">        <span class="n">prompt_tokens</span><span class="o">=</span><span class="n">usage1</span><span class="o">.</span><span class="n">prompt_tokens</span> <span class="o">+</span> <span class="n">usage2</span><span class="o">.</span><span class="n">prompt_tokens</span><span class="p">,</span>
</span><span id="line-290">        <span class="n">completion_tokens</span><span class="o">=</span><span class="n">usage1</span><span class="o">.</span><span class="n">completion_tokens</span> <span class="o">+</span> <span class="n">usage2</span><span class="o">.</span><span class="n">completion_tokens</span><span class="p">,</span>
</span><span id="line-291">    <span class="p">)</span>
</span><span id="line-292">
</span><span id="line-293">
</span><span id="line-294"><span class="k">def</span> <span class="nf">convert_tools</span><span class="p">(</span>
</span><span id="line-295">    <span class="n">tools</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tool</span> <span class="o">|</span> <span class="n">ToolSchema</span><span class="p">],</span>
</span><span id="line-296"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatCompletionToolParam</span><span class="p">]:</span>
</span><span id="line-297">    <span class="n">result</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChatCompletionToolParam</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-298">    <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
</span><span id="line-299">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="n">Tool</span><span class="p">):</span>
</span><span id="line-300">            <span class="n">tool_schema</span> <span class="o">=</span> <span class="n">tool</span><span class="o">.</span><span class="n">schema</span>
</span><span id="line-301">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-302">            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tool</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
</span><span id="line-303">            <span class="n">tool_schema</span> <span class="o">=</span> <span class="n">tool</span>
</span><span id="line-304">
</span><span id="line-305">        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="line-306">            <span class="n">ChatCompletionToolParam</span><span class="p">(</span>
</span><span id="line-307">                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">,</span>
</span><span id="line-308">                <span class="n">function</span><span class="o">=</span><span class="n">FunctionDefinition</span><span class="p">(</span>
</span><span id="line-309">                    <span class="n">name</span><span class="o">=</span><span class="n">tool_schema</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
</span><span id="line-310">                    <span class="n">description</span><span class="o">=</span><span class="p">(</span><span class="n">tool_schema</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;description&quot;</span> <span class="ow">in</span> <span class="n">tool_schema</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
</span><span id="line-311">                    <span class="n">parameters</span><span class="o">=</span><span class="p">(</span>
</span><span id="line-312">                        <span class="n">cast</span><span class="p">(</span><span class="n">FunctionParameters</span><span class="p">,</span> <span class="n">tool_schema</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;parameters&quot;</span> <span class="ow">in</span> <span class="n">tool_schema</span> <span class="k">else</span> <span class="p">{}</span>
</span><span id="line-313">                    <span class="p">),</span>
</span><span id="line-314">                <span class="p">),</span>
</span><span id="line-315">            <span class="p">)</span>
</span><span id="line-316">        <span class="p">)</span>
</span><span id="line-317">    <span class="c1"># Check if all tools have valid names.</span>
</span><span id="line-318">    <span class="k">for</span> <span class="n">tool_param</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
</span><span id="line-319">        <span class="n">assert_valid_name</span><span class="p">(</span><span class="n">tool_param</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
</span><span id="line-320">    <span class="k">return</span> <span class="n">result</span>
</span><span id="line-321">
</span><span id="line-322">
</span><span id="line-323"><span class="k">def</span> <span class="nf">normalize_name</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="line-324"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-325"><span class="sd">    LLMs sometimes ask functions while ignoring their own format requirements, this function should be used to replace invalid characters with &quot;_&quot;.</span>
</span><span id="line-326">
</span><span id="line-327"><span class="sd">    Prefer _assert_valid_name for validating user configuration or input</span>
</span><span id="line-328"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="line-329">    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^a-zA-Z0-9_-]&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)[:</span><span class="mi">64</span><span class="p">]</span>
</span><span id="line-330">
</span><span id="line-331">
</span><span id="line-332"><span class="k">def</span> <span class="nf">assert_valid_name</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="line-333"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-334"><span class="sd">    Ensure that configured names are valid, raises ValueError if not.</span>
</span><span id="line-335">
</span><span id="line-336"><span class="sd">    For munging LLM responses use _normalize_name to ensure LLM specified names don&#39;t break the API.</span>
</span><span id="line-337"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="line-338">    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[a-zA-Z0-9_-]+$&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
</span><span id="line-339">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid name: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">. Only letters, numbers, &#39;_&#39; and &#39;-&#39; are allowed.&quot;</span><span class="p">)</span>
</span><span id="line-340">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">:</span>
</span><span id="line-341">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid name: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">. Name must be less than 64 characters.&quot;</span><span class="p">)</span>
</span><span id="line-342">    <span class="k">return</span> <span class="n">name</span>
</span><span id="line-343">
</span><span id="line-344">
</span><span id="line-345"><span class="k">class</span> <span class="nc">BaseOpenAIChatCompletionClient</span><span class="p">(</span><span class="n">ChatCompletionClient</span><span class="p">):</span>
</span><span id="line-346">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="line-347">        <span class="bp">self</span><span class="p">,</span>
</span><span id="line-348">        <span class="n">client</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">AsyncOpenAI</span><span class="p">,</span> <span class="n">AsyncAzureOpenAI</span><span class="p">],</span>
</span><span id="line-349">        <span class="n">create_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="line-350">        <span class="n">model_capabilities</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ModelCapabilities</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="line-351">    <span class="p">):</span>
</span><span id="line-352">        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">client</span>
</span><span id="line-353">        <span class="k">if</span> <span class="n">model_capabilities</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-354">            <span class="bp">self</span><span class="o">.</span><span class="n">_model_capabilities</span> <span class="o">=</span> <span class="n">_model_info</span><span class="o">.</span><span class="n">get_capabilities</span><span class="p">(</span><span class="n">create_args</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">])</span>
</span><span id="line-355">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-356">            <span class="bp">self</span><span class="o">.</span><span class="n">_model_capabilities</span> <span class="o">=</span> <span class="n">model_capabilities</span>
</span><span id="line-357">
</span><span id="line-358">        <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="line-359">        <span class="k">if</span> <span class="s2">&quot;model&quot;</span> <span class="ow">in</span> <span class="n">create_args</span><span class="p">:</span>
</span><span id="line-360">            <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_model</span> <span class="o">=</span> <span class="n">_model_info</span><span class="o">.</span><span class="n">resolve_model</span><span class="p">(</span><span class="n">create_args</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">])</span>
</span><span id="line-361">
</span><span id="line-362">        <span class="k">if</span> <span class="p">(</span>
</span><span id="line-363">            <span class="s2">&quot;response_format&quot;</span> <span class="ow">in</span> <span class="n">create_args</span>
</span><span id="line-364">            <span class="ow">and</span> <span class="n">create_args</span><span class="p">[</span><span class="s2">&quot;response_format&quot;</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;json_object&quot;</span>
</span><span id="line-365">            <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_capabilities</span><span class="p">[</span><span class="s2">&quot;json_output&quot;</span><span class="p">]</span>
</span><span id="line-366">        <span class="p">):</span>
</span><span id="line-367">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model does not support JSON output&quot;</span><span class="p">)</span>
</span><span id="line-368">
</span><span id="line-369">        <span class="bp">self</span><span class="o">.</span><span class="n">_create_args</span> <span class="o">=</span> <span class="n">create_args</span>
</span><span id="line-370">        <span class="bp">self</span><span class="o">.</span><span class="n">_total_usage</span> <span class="o">=</span> <span class="n">RequestUsage</span><span class="p">(</span><span class="n">prompt_tokens</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">completion_tokens</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="line-371">        <span class="bp">self</span><span class="o">.</span><span class="n">_actual_usage</span> <span class="o">=</span> <span class="n">RequestUsage</span><span class="p">(</span><span class="n">prompt_tokens</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">completion_tokens</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="line-372">
</span><span id="line-373">    <span class="nd">@classmethod</span>
</span><span id="line-374">    <span class="k">def</span> <span class="nf">create_from_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">ChatCompletionClient</span><span class="p">:</span>
</span><span id="line-375">        <span class="k">return</span> <span class="n">OpenAIChatCompletionClient</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>
</span><span id="line-376">
</span><span id="line-377">    <span class="k">async</span> <span class="k">def</span> <span class="nf">create</span><span class="p">(</span>
</span><span id="line-378">        <span class="bp">self</span><span class="p">,</span>
</span><span id="line-379">        <span class="n">messages</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">LLMMessage</span><span class="p">],</span>
</span><span id="line-380">        <span class="n">tools</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tool</span> <span class="o">|</span> <span class="n">ToolSchema</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="line-381">        <span class="n">json_output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="line-382">        <span class="n">extra_create_args</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
</span><span id="line-383">        <span class="n">cancellation_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CancellationToken</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="line-384">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CreateResult</span><span class="p">:</span>
</span><span id="line-385">        <span class="c1"># Make sure all extra_create_args are valid</span>
</span><span id="line-386">        <span class="n">extra_create_args_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">extra_create_args</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="line-387">        <span class="k">if</span> <span class="ow">not</span> <span class="n">create_kwargs</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">extra_create_args_keys</span><span class="p">):</span>
</span><span id="line-388">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extra create args are invalid: </span><span class="si">{</span><span class="n">extra_create_args_keys</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">create_kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="line-389">
</span><span id="line-390">        <span class="c1"># Copy the create args and overwrite anything in extra_create_args</span>
</span><span id="line-391">        <span class="n">create_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_args</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="line-392">        <span class="n">create_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_create_args</span><span class="p">)</span>
</span><span id="line-393">
</span><span id="line-394">        <span class="c1"># Declare use_beta_client</span>
</span><span id="line-395">        <span class="n">use_beta_client</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-396">        <span class="n">response_format_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="line-397">
</span><span id="line-398">        <span class="k">if</span> <span class="s2">&quot;response_format&quot;</span> <span class="ow">in</span> <span class="n">create_args</span><span class="p">:</span>
</span><span id="line-399">            <span class="n">value</span> <span class="o">=</span> <span class="n">create_args</span><span class="p">[</span><span class="s2">&quot;response_format&quot;</span><span class="p">]</span>
</span><span id="line-400">            <span class="c1"># If value is a Pydantic model class, use the beta client</span>
</span><span id="line-401">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
</span><span id="line-402">                <span class="n">response_format_value</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="line-403">                <span class="n">use_beta_client</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="line-404">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-405">                <span class="c1"># response_format_value is not a Pydantic model class</span>
</span><span id="line-406">                <span class="n">use_beta_client</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-407">                <span class="n">response_format_value</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="line-408">
</span><span id="line-409">        <span class="c1"># Remove &#39;response_format&#39; from create_args to prevent passing it twice</span>
</span><span id="line-410">        <span class="n">create_args_no_response_format</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">create_args</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;response_format&quot;</span><span class="p">}</span>
</span><span id="line-411">
</span><span id="line-412">        <span class="c1"># TODO: allow custom handling.</span>
</span><span id="line-413">        <span class="c1"># For now we raise an error if images are present and vision is not supported</span>
</span><span id="line-414">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">capabilities</span><span class="p">[</span><span class="s2">&quot;vision&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="line-415">            <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
</span><span id="line-416">                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">UserMessage</span><span class="p">):</span>
</span><span id="line-417">                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Image</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">):</span>
</span><span id="line-418">                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model does not support vision and image was provided&quot;</span><span class="p">)</span>
</span><span id="line-419">
</span><span id="line-420">        <span class="k">if</span> <span class="n">json_output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-421">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">capabilities</span><span class="p">[</span><span class="s2">&quot;json_output&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">json_output</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="line-422">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model does not support JSON output&quot;</span><span class="p">)</span>
</span><span id="line-423">
</span><span id="line-424">            <span class="k">if</span> <span class="n">json_output</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="line-425">                <span class="n">create_args</span><span class="p">[</span><span class="s2">&quot;response_format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;json_object&quot;</span><span class="p">}</span>
</span><span id="line-426">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-427">                <span class="n">create_args</span><span class="p">[</span><span class="s2">&quot;response_format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">}</span>
</span><span id="line-428">
</span><span id="line-429">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">capabilities</span><span class="p">[</span><span class="s2">&quot;json_output&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">json_output</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="line-430">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model does not support JSON output&quot;</span><span class="p">)</span>
</span><span id="line-431">
</span><span id="line-432">        <span class="n">oai_messages_nested</span> <span class="o">=</span> <span class="p">[</span><span class="n">to_oai_type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">]</span>
</span><span id="line-433">        <span class="n">oai_messages</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">oai_messages_nested</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
</span><span id="line-434">
</span><span id="line-435">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">capabilities</span><span class="p">[</span><span class="s2">&quot;function_calling&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="line-436">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model does not support function calling&quot;</span><span class="p">)</span>
</span><span id="line-437">        <span class="n">future</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Task</span><span class="p">[</span><span class="n">ParsedChatCompletion</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]],</span> <span class="n">Task</span><span class="p">[</span><span class="n">ChatCompletion</span><span class="p">]]</span>
</span><span id="line-438">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="line-439">            <span class="n">converted_tools</span> <span class="o">=</span> <span class="n">convert_tools</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
</span><span id="line-440">            <span class="k">if</span> <span class="n">use_beta_client</span><span class="p">:</span>
</span><span id="line-441">                <span class="c1"># Pass response_format_value if it&#39;s not None</span>
</span><span id="line-442">                <span class="k">if</span> <span class="n">response_format_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-443">                    <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span>
</span><span id="line-444">                        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
</span><span id="line-445">                            <span class="n">messages</span><span class="o">=</span><span class="n">oai_messages</span><span class="p">,</span>
</span><span id="line-446">                            <span class="n">tools</span><span class="o">=</span><span class="n">converted_tools</span><span class="p">,</span>
</span><span id="line-447">                            <span class="n">response_format</span><span class="o">=</span><span class="n">response_format_value</span><span class="p">,</span>
</span><span id="line-448">                            <span class="o">**</span><span class="n">create_args_no_response_format</span><span class="p">,</span>
</span><span id="line-449">                        <span class="p">)</span>
</span><span id="line-450">                    <span class="p">)</span>
</span><span id="line-451">                <span class="k">else</span><span class="p">:</span>
</span><span id="line-452">                    <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span>
</span><span id="line-453">                        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
</span><span id="line-454">                            <span class="n">messages</span><span class="o">=</span><span class="n">oai_messages</span><span class="p">,</span>
</span><span id="line-455">                            <span class="n">tools</span><span class="o">=</span><span class="n">converted_tools</span><span class="p">,</span>
</span><span id="line-456">                            <span class="o">**</span><span class="n">create_args_no_response_format</span><span class="p">,</span>
</span><span id="line-457">                        <span class="p">)</span>
</span><span id="line-458">                    <span class="p">)</span>
</span><span id="line-459">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-460">                <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span>
</span><span id="line-461">                    <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span id="line-462">                        <span class="n">messages</span><span class="o">=</span><span class="n">oai_messages</span><span class="p">,</span>
</span><span id="line-463">                        <span class="n">stream</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="line-464">                        <span class="n">tools</span><span class="o">=</span><span class="n">converted_tools</span><span class="p">,</span>
</span><span id="line-465">                        <span class="o">**</span><span class="n">create_args</span><span class="p">,</span>
</span><span id="line-466">                    <span class="p">)</span>
</span><span id="line-467">                <span class="p">)</span>
</span><span id="line-468">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-469">            <span class="k">if</span> <span class="n">use_beta_client</span><span class="p">:</span>
</span><span id="line-470">                <span class="k">if</span> <span class="n">response_format_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-471">                    <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span>
</span><span id="line-472">                        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
</span><span id="line-473">                            <span class="n">messages</span><span class="o">=</span><span class="n">oai_messages</span><span class="p">,</span>
</span><span id="line-474">                            <span class="n">response_format</span><span class="o">=</span><span class="n">response_format_value</span><span class="p">,</span>
</span><span id="line-475">                            <span class="o">**</span><span class="n">create_args_no_response_format</span><span class="p">,</span>
</span><span id="line-476">                        <span class="p">)</span>
</span><span id="line-477">                    <span class="p">)</span>
</span><span id="line-478">                <span class="k">else</span><span class="p">:</span>
</span><span id="line-479">                    <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span>
</span><span id="line-480">                        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
</span><span id="line-481">                            <span class="n">messages</span><span class="o">=</span><span class="n">oai_messages</span><span class="p">,</span>
</span><span id="line-482">                            <span class="o">**</span><span class="n">create_args_no_response_format</span><span class="p">,</span>
</span><span id="line-483">                        <span class="p">)</span>
</span><span id="line-484">                    <span class="p">)</span>
</span><span id="line-485">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-486">                <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span>
</span><span id="line-487">                    <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span id="line-488">                        <span class="n">messages</span><span class="o">=</span><span class="n">oai_messages</span><span class="p">,</span>
</span><span id="line-489">                        <span class="n">stream</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="line-490">                        <span class="o">**</span><span class="n">create_args</span><span class="p">,</span>
</span><span id="line-491">                    <span class="p">)</span>
</span><span id="line-492">                <span class="p">)</span>
</span><span id="line-493">
</span><span id="line-494">        <span class="k">if</span> <span class="n">cancellation_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-495">            <span class="n">cancellation_token</span><span class="o">.</span><span class="n">link_future</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
</span><span id="line-496">        <span class="n">result</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ParsedChatCompletion</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">],</span> <span class="n">ChatCompletion</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">future</span>
</span><span id="line-497">        <span class="k">if</span> <span class="n">use_beta_client</span><span class="p">:</span>
</span><span id="line-498">            <span class="n">result</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">ParsedChatCompletion</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">result</span><span class="p">)</span>
</span><span id="line-499">
</span><span id="line-500">        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">usage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-501">            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="line-502">                <span class="n">LLMCallEvent</span><span class="p">(</span>
</span><span id="line-503">                    <span class="n">prompt_tokens</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="n">prompt_tokens</span><span class="p">,</span>
</span><span id="line-504">                    <span class="n">completion_tokens</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="n">completion_tokens</span><span class="p">,</span>
</span><span id="line-505">                <span class="p">)</span>
</span><span id="line-506">            <span class="p">)</span>
</span><span id="line-507">
</span><span id="line-508">        <span class="n">usage</span> <span class="o">=</span> <span class="n">RequestUsage</span><span class="p">(</span>
</span><span id="line-509">            <span class="c1"># TODO backup token counting</span>
</span><span id="line-510">            <span class="n">prompt_tokens</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="n">prompt_tokens</span> <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">usage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="line-511">            <span class="n">completion_tokens</span><span class="o">=</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="n">completion_tokens</span> <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">usage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="line-512">        <span class="p">)</span>
</span><span id="line-513">
</span><span id="line-514">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-515">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolved_model</span> <span class="o">!=</span> <span class="n">result</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
</span><span id="line-516">                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span id="line-517">                    <span class="sa">f</span><span class="s2">&quot;Resolved model mismatch: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_resolved_model</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">. Model mapping may be incorrect.&quot;</span><span class="p">,</span>
</span><span id="line-518">                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span><span id="line-519">                <span class="p">)</span>
</span><span id="line-520">
</span><span id="line-521">        <span class="c1"># Limited to a single choice currently.</span>
</span><span id="line-522">        <span class="n">choice</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ParsedChoice</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">ParsedChoice</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">],</span> <span class="n">Choice</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="line-523">        <span class="k">if</span> <span class="n">choice</span><span class="o">.</span><span class="n">finish_reason</span> <span class="o">==</span> <span class="s2">&quot;function_call&quot;</span><span class="p">:</span>
</span><span id="line-524">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Function calls are not supported in this context&quot;</span><span class="p">)</span>
</span><span id="line-525">
</span><span id="line-526">        <span class="n">content</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionCall</span><span class="p">]]</span>
</span><span id="line-527">        <span class="k">if</span> <span class="n">choice</span><span class="o">.</span><span class="n">finish_reason</span> <span class="o">==</span> <span class="s2">&quot;tool_calls&quot;</span><span class="p">:</span>
</span><span id="line-528">            <span class="k">assert</span> <span class="n">choice</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="line-529">            <span class="k">assert</span> <span class="n">choice</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">function_call</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="line-530">
</span><span id="line-531">            <span class="c1"># NOTE: If OAI response type changes, this will need to be updated</span>
</span><span id="line-532">            <span class="n">content</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="line-533">                <span class="n">FunctionCall</span><span class="p">(</span>
</span><span id="line-534">                    <span class="nb">id</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="line-535">                    <span class="n">arguments</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">arguments</span><span class="p">,</span>
</span><span id="line-536">                    <span class="n">name</span><span class="o">=</span><span class="n">normalize_name</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
</span><span id="line-537">                <span class="p">)</span>
</span><span id="line-538">                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">choice</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span>
</span><span id="line-539">            <span class="p">]</span>
</span><span id="line-540">            <span class="n">finish_reason</span> <span class="o">=</span> <span class="s2">&quot;function_calls&quot;</span>
</span><span id="line-541">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-542">            <span class="n">finish_reason</span> <span class="o">=</span> <span class="n">choice</span><span class="o">.</span><span class="n">finish_reason</span>
</span><span id="line-543">            <span class="n">content</span> <span class="o">=</span> <span class="n">choice</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
</span><span id="line-544">        <span class="n">logprobs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ChatCompletionTokenLogprob</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="line-545">        <span class="k">if</span> <span class="n">choice</span><span class="o">.</span><span class="n">logprobs</span> <span class="ow">and</span> <span class="n">choice</span><span class="o">.</span><span class="n">logprobs</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
</span><span id="line-546">            <span class="n">logprobs</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="line-547">                <span class="n">ChatCompletionTokenLogprob</span><span class="p">(</span>
</span><span id="line-548">                    <span class="n">token</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">token</span><span class="p">,</span>
</span><span id="line-549">                    <span class="n">logprob</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">logprob</span><span class="p">,</span>
</span><span id="line-550">                    <span class="n">top_logprobs</span><span class="o">=</span><span class="p">[</span><span class="n">TopLogprob</span><span class="p">(</span><span class="n">logprob</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">logprob</span><span class="p">,</span> <span class="nb">bytes</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">bytes</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">top_logprobs</span><span class="p">],</span>
</span><span id="line-551">                    <span class="nb">bytes</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">bytes</span><span class="p">,</span>
</span><span id="line-552">                <span class="p">)</span>
</span><span id="line-553">                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">choice</span><span class="o">.</span><span class="n">logprobs</span><span class="o">.</span><span class="n">content</span>
</span><span id="line-554">            <span class="p">]</span>
</span><span id="line-555">        <span class="n">response</span> <span class="o">=</span> <span class="n">CreateResult</span><span class="p">(</span>
</span><span id="line-556">            <span class="n">finish_reason</span><span class="o">=</span><span class="n">finish_reason</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
</span><span id="line-557">            <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
</span><span id="line-558">            <span class="n">usage</span><span class="o">=</span><span class="n">usage</span><span class="p">,</span>
</span><span id="line-559">            <span class="n">cached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="line-560">            <span class="n">logprobs</span><span class="o">=</span><span class="n">logprobs</span><span class="p">,</span>
</span><span id="line-561">        <span class="p">)</span>
</span><span id="line-562">
</span><span id="line-563">        <span class="n">_add_usage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_actual_usage</span><span class="p">,</span> <span class="n">usage</span><span class="p">)</span>
</span><span id="line-564">        <span class="n">_add_usage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_total_usage</span><span class="p">,</span> <span class="n">usage</span><span class="p">)</span>
</span><span id="line-565">
</span><span id="line-566">        <span class="c1"># TODO - why is this cast needed?</span>
</span><span id="line-567">        <span class="k">return</span> <span class="n">response</span>
</span><span id="line-568">
</span><span id="line-569">    <span class="k">async</span> <span class="k">def</span> <span class="nf">create_stream</span><span class="p">(</span>
</span><span id="line-570">        <span class="bp">self</span><span class="p">,</span>
</span><span id="line-571">        <span class="n">messages</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">LLMMessage</span><span class="p">],</span>
</span><span id="line-572">        <span class="n">tools</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tool</span> <span class="o">|</span> <span class="n">ToolSchema</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
</span><span id="line-573">        <span class="n">json_output</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="line-574">        <span class="n">extra_create_args</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span>
</span><span id="line-575">        <span class="n">cancellation_token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CancellationToken</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="line-576">        <span class="o">*</span><span class="p">,</span>
</span><span id="line-577">        <span class="n">max_consecutive_empty_chunk_tolerance</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="line-578">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">CreateResult</span><span class="p">],</span> <span class="kc">None</span><span class="p">]:</span>
</span><span id="line-579"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line-580"><span class="sd">        Creates an AsyncGenerator that will yield a  stream of chat completions based on the provided messages and tools.</span>
</span><span id="line-581">
</span><span id="line-582"><span class="sd">        Args:</span>
</span><span id="line-583"><span class="sd">            messages (Sequence[LLMMessage]): A sequence of messages to be processed.</span>
</span><span id="line-584"><span class="sd">            tools (Sequence[Tool | ToolSchema], optional): A sequence of tools to be used in the completion. Defaults to `[]`.</span>
</span><span id="line-585"><span class="sd">            json_output (Optional[bool], optional): If True, the output will be in JSON format. Defaults to None.</span>
</span><span id="line-586"><span class="sd">            extra_create_args (Mapping[str, Any], optional): Additional arguments for the creation process. Default to `{}`.</span>
</span><span id="line-587"><span class="sd">            cancellation_token (Optional[CancellationToken], optional): A token to cancel the operation. Defaults to None.</span>
</span><span id="line-588"><span class="sd">            max_consecutive_empty_chunk_tolerance (int): The maximum number of consecutive empty chunks to tolerate before raising a ValueError. This seems to only be needed to set when using `AzureOpenAIChatCompletionClient`. Defaults to 0.</span>
</span><span id="line-589">
</span><span id="line-590"><span class="sd">        Yields:</span>
</span><span id="line-591"><span class="sd">            AsyncGenerator[Union[str, CreateResult], None]: A generator yielding the completion results as they are produced.</span>
</span><span id="line-592">
</span><span id="line-593"><span class="sd">        In streaming, the default behaviour is not return token usage counts. See: [OpenAI API reference for possible args](https://platform.openai.com/docs/api-reference/chat/create).</span>
</span><span id="line-594"><span class="sd">        However `extra_create_args={&quot;stream_options&quot;: {&quot;include_usage&quot;: True}}` will (if supported by the accessed API)</span>
</span><span id="line-595"><span class="sd">        return a final chunk with usage set to a RequestUsage object having prompt and completion token counts,</span>
</span><span id="line-596"><span class="sd">        all preceding chunks will have usage as None. See: [stream_options](https://platform.openai.com/docs/api-reference/chat/create#chat-create-stream_options).</span>
</span><span id="line-597">
</span><span id="line-598"><span class="sd">        Other examples of OPENAI supported arguments that can be included in `extra_create_args`:</span>
</span><span id="line-599"><span class="sd">            - `temperature` (float): Controls the randomness of the output. Higher values (e.g., 0.8) make the output more random, while lower values (e.g., 0.2) make it more focused and deterministic.</span>
</span><span id="line-600"><span class="sd">            - `max_tokens` (int): The maximum number of tokens to generate in the completion.</span>
</span><span id="line-601"><span class="sd">            - `top_p` (float): An alternative to sampling with temperature, called nucleus sampling, where the model considers the results of the tokens with top_p probability mass.</span>
</span><span id="line-602"><span class="sd">            - `frequency_penalty` (float): A value between -2.0 and 2.0 that penalizes new tokens based on their existing frequency in the text so far, decreasing the likelihood of repeated phrases.</span>
</span><span id="line-603"><span class="sd">            - `presence_penalty` (float): A value between -2.0 and 2.0 that penalizes new tokens based on whether they appear in the text so far, encouraging the model to talk about new topics.</span>
</span><span id="line-604"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="line-605">        <span class="c1"># Make sure all extra_create_args are valid</span>
</span><span id="line-606">        <span class="n">extra_create_args_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">extra_create_args</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="line-607">        <span class="k">if</span> <span class="ow">not</span> <span class="n">create_kwargs</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="n">extra_create_args_keys</span><span class="p">):</span>
</span><span id="line-608">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Extra create args are invalid: </span><span class="si">{</span><span class="n">extra_create_args_keys</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">create_kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="line-609">
</span><span id="line-610">        <span class="c1"># Copy the create args and overwrite anything in extra_create_args</span>
</span><span id="line-611">        <span class="n">create_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_args</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="line-612">        <span class="n">create_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extra_create_args</span><span class="p">)</span>
</span><span id="line-613">
</span><span id="line-614">        <span class="n">oai_messages_nested</span> <span class="o">=</span> <span class="p">[</span><span class="n">to_oai_type</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">]</span>
</span><span id="line-615">        <span class="n">oai_messages</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">oai_messages_nested</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
</span><span id="line-616">
</span><span id="line-617">        <span class="c1"># TODO: allow custom handling.</span>
</span><span id="line-618">        <span class="c1"># For now we raise an error if images are present and vision is not supported</span>
</span><span id="line-619">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">capabilities</span><span class="p">[</span><span class="s2">&quot;vision&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="line-620">            <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
</span><span id="line-621">                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">UserMessage</span><span class="p">):</span>
</span><span id="line-622">                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Image</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">):</span>
</span><span id="line-623">                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model does not support vision and image was provided&quot;</span><span class="p">)</span>
</span><span id="line-624">
</span><span id="line-625">        <span class="k">if</span> <span class="n">json_output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-626">            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">capabilities</span><span class="p">[</span><span class="s2">&quot;json_output&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">json_output</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="line-627">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model does not support JSON output&quot;</span><span class="p">)</span>
</span><span id="line-628">
</span><span id="line-629">            <span class="k">if</span> <span class="n">json_output</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="line-630">                <span class="n">create_args</span><span class="p">[</span><span class="s2">&quot;response_format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;json_object&quot;</span><span class="p">}</span>
</span><span id="line-631">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-632">                <span class="n">create_args</span><span class="p">[</span><span class="s2">&quot;response_format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">}</span>
</span><span id="line-633">
</span><span id="line-634">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="line-635">            <span class="n">converted_tools</span> <span class="o">=</span> <span class="n">convert_tools</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
</span><span id="line-636">            <span class="n">stream_future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span>
</span><span id="line-637">                <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span><span id="line-638">                    <span class="n">messages</span><span class="o">=</span><span class="n">oai_messages</span><span class="p">,</span>
</span><span id="line-639">                    <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="line-640">                    <span class="n">tools</span><span class="o">=</span><span class="n">converted_tools</span><span class="p">,</span>
</span><span id="line-641">                    <span class="o">**</span><span class="n">create_args</span><span class="p">,</span>
</span><span id="line-642">                <span class="p">)</span>
</span><span id="line-643">            <span class="p">)</span>
</span><span id="line-644">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-645">            <span class="n">stream_future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span>
</span><span id="line-646">                <span class="bp">self</span><span class="o">.</span><span class="n">_client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">messages</span><span class="o">=</span><span class="n">oai_messages</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">create_args</span><span class="p">)</span>
</span><span id="line-647">            <span class="p">)</span>
</span><span id="line-648">        <span class="k">if</span> <span class="n">cancellation_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-649">            <span class="n">cancellation_token</span><span class="o">.</span><span class="n">link_future</span><span class="p">(</span><span class="n">stream_future</span><span class="p">)</span>
</span><span id="line-650">        <span class="n">stream</span> <span class="o">=</span> <span class="k">await</span> <span class="n">stream_future</span>
</span><span id="line-651">        <span class="n">choice</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ParsedChoice</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">ParsedChoice</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">],</span> <span class="n">ChunkChoice</span><span class="p">]</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">ChunkChoice</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="line-652">        <span class="n">chunk</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="line-653">        <span class="n">stop_reason</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="line-654">        <span class="n">maybe_model</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="line-655">        <span class="n">content_deltas</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-656">        <span class="n">full_tool_calls</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">FunctionCall</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="line-657">        <span class="n">completion_tokens</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="line-658">        <span class="n">logprobs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">ChatCompletionTokenLogprob</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="line-659">        <span class="n">empty_chunk_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="line-660">
</span><span id="line-661">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="line-662">            <span class="k">try</span><span class="p">:</span>
</span><span id="line-663">                <span class="n">chunk_future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="n">anext</span><span class="p">(</span><span class="n">stream</span><span class="p">))</span>
</span><span id="line-664">                <span class="k">if</span> <span class="n">cancellation_token</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-665">                    <span class="n">cancellation_token</span><span class="o">.</span><span class="n">link_future</span><span class="p">(</span><span class="n">chunk_future</span><span class="p">)</span>
</span><span id="line-666">                <span class="n">chunk</span> <span class="o">=</span> <span class="k">await</span> <span class="n">chunk_future</span>
</span><span id="line-667">
</span><span id="line-668">                <span class="c1"># This is to address a bug in AzureOpenAIChatCompletionClient. OpenAIChatCompletionClient works fine.</span>
</span><span id="line-669">                <span class="c1">#  https://github.com/microsoft/autogen/issues/4213</span>
</span><span id="line-670">                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">choices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="line-671">                    <span class="n">empty_chunk_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="line-672">                    <span class="k">if</span> <span class="n">max_consecutive_empty_chunk_tolerance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="line-673">                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="line-674">                            <span class="s2">&quot;Consecutive empty chunks found. Change max_empty_consecutive_chunk_tolerance to increase empty chunk tolerance&quot;</span>
</span><span id="line-675">                        <span class="p">)</span>
</span><span id="line-676">                    <span class="k">elif</span> <span class="n">empty_chunk_count</span> <span class="o">&gt;=</span> <span class="n">max_consecutive_empty_chunk_tolerance</span><span class="p">:</span>
</span><span id="line-677">                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Exceeded the threshold of receiving consecutive empty chunks&quot;</span><span class="p">)</span>
</span><span id="line-678">                    <span class="k">continue</span>
</span><span id="line-679">                <span class="k">else</span><span class="p">:</span>
</span><span id="line-680">                    <span class="n">empty_chunk_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="line-681">
</span><span id="line-682">                <span class="c1"># to process usage chunk in streaming situations</span>
</span><span id="line-683">                <span class="c1"># add    stream_options={&quot;include_usage&quot;: True} in the initialization of OpenAIChatCompletionClient(...)</span>
</span><span id="line-684">                <span class="c1"># However the different api&#39;s</span>
</span><span id="line-685">                <span class="c1"># OPENAI api usage chunk produces no choices so need to check if there is a choice</span>
</span><span id="line-686">                <span class="c1"># liteLLM api usage chunk does produce choices</span>
</span><span id="line-687">                <span class="n">choice</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="line-688">                    <span class="n">chunk</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="line-689">                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">choices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="line-690">                    <span class="k">else</span> <span class="n">choice</span>
</span><span id="line-691">                    <span class="k">if</span> <span class="n">chunk</span><span class="o">.</span><span class="n">usage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">stop_reason</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="line-692">                    <span class="k">else</span> <span class="n">cast</span><span class="p">(</span><span class="n">ChunkChoice</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="line-693">                <span class="p">)</span>
</span><span id="line-694">
</span><span id="line-695">                <span class="c1"># for liteLLM chunk usage, do the following hack keeping the pervious chunk.stop_reason (if set).</span>
</span><span id="line-696">                <span class="c1"># set the stop_reason for the usage chunk to the prior stop_reason</span>
</span><span id="line-697">                <span class="n">stop_reason</span> <span class="o">=</span> <span class="n">choice</span><span class="o">.</span><span class="n">finish_reason</span> <span class="k">if</span> <span class="n">chunk</span><span class="o">.</span><span class="n">usage</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">stop_reason</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">stop_reason</span>
</span><span id="line-698">                <span class="n">maybe_model</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">model</span>
</span><span id="line-699">                <span class="c1"># First try get content</span>
</span><span id="line-700">                <span class="k">if</span> <span class="n">choice</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-701">                    <span class="n">content_deltas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">choice</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span><span id="line-702">                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">choice</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">content</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="line-703">                        <span class="k">yield</span> <span class="n">choice</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">content</span>
</span><span id="line-704">                    <span class="k">continue</span>
</span><span id="line-705">
</span><span id="line-706">                <span class="c1"># Otherwise, get tool calls</span>
</span><span id="line-707">                <span class="k">if</span> <span class="n">choice</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">tool_calls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-708">                    <span class="k">for</span> <span class="n">tool_call_chunk</span> <span class="ow">in</span> <span class="n">choice</span><span class="o">.</span><span class="n">delta</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
</span><span id="line-709">                        <span class="n">idx</span> <span class="o">=</span> <span class="n">tool_call_chunk</span><span class="o">.</span><span class="n">index</span>
</span><span id="line-710">                        <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">full_tool_calls</span><span class="p">:</span>
</span><span id="line-711">                            <span class="c1"># We ignore the type hint here because we want to fill in type when the delta provides it</span>
</span><span id="line-712">                            <span class="n">full_tool_calls</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">FunctionCall</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="line-713">
</span><span id="line-714">                        <span class="k">if</span> <span class="n">tool_call_chunk</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-715">                            <span class="n">full_tool_calls</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="o">+=</span> <span class="n">tool_call_chunk</span><span class="o">.</span><span class="n">id</span>
</span><span id="line-716">
</span><span id="line-717">                        <span class="k">if</span> <span class="n">tool_call_chunk</span><span class="o">.</span><span class="n">function</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-718">                            <span class="k">if</span> <span class="n">tool_call_chunk</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-719">                                <span class="n">full_tool_calls</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">+=</span> <span class="n">tool_call_chunk</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">name</span>
</span><span id="line-720">                            <span class="k">if</span> <span class="n">tool_call_chunk</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">arguments</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-721">                                <span class="n">full_tool_calls</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">arguments</span> <span class="o">+=</span> <span class="n">tool_call_chunk</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">arguments</span>
</span><span id="line-722">                <span class="k">if</span> <span class="n">choice</span><span class="o">.</span><span class="n">logprobs</span> <span class="ow">and</span> <span class="n">choice</span><span class="o">.</span><span class="n">logprobs</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
</span><span id="line-723">                    <span class="n">logprobs</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="line-724">                        <span class="n">ChatCompletionTokenLogprob</span><span class="p">(</span>
</span><span id="line-725">                            <span class="n">token</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">token</span><span class="p">,</span>
</span><span id="line-726">                            <span class="n">logprob</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">logprob</span><span class="p">,</span>
</span><span id="line-727">                            <span class="n">top_logprobs</span><span class="o">=</span><span class="p">[</span><span class="n">TopLogprob</span><span class="p">(</span><span class="n">logprob</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">logprob</span><span class="p">,</span> <span class="nb">bytes</span><span class="o">=</span><span class="n">y</span><span class="o">.</span><span class="n">bytes</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">top_logprobs</span><span class="p">],</span>
</span><span id="line-728">                            <span class="nb">bytes</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">bytes</span><span class="p">,</span>
</span><span id="line-729">                        <span class="p">)</span>
</span><span id="line-730">                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">choice</span><span class="o">.</span><span class="n">logprobs</span><span class="o">.</span><span class="n">content</span>
</span><span id="line-731">                    <span class="p">]</span>
</span><span id="line-732">
</span><span id="line-733">            <span class="k">except</span> <span class="ne">StopAsyncIteration</span><span class="p">:</span>
</span><span id="line-734">                <span class="k">break</span>
</span><span id="line-735">
</span><span id="line-736">        <span class="n">model</span> <span class="o">=</span> <span class="n">maybe_model</span> <span class="ow">or</span> <span class="n">create_args</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>
</span><span id="line-737">        <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;gpt-35&quot;</span><span class="p">,</span> <span class="s2">&quot;gpt-3.5&quot;</span><span class="p">)</span>  <span class="c1"># hack for Azure API</span>
</span><span id="line-738">
</span><span id="line-739">        <span class="k">if</span> <span class="n">chunk</span> <span class="ow">and</span> <span class="n">chunk</span><span class="o">.</span><span class="n">usage</span><span class="p">:</span>
</span><span id="line-740">            <span class="n">prompt_tokens</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="n">prompt_tokens</span>
</span><span id="line-741">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-742">            <span class="n">prompt_tokens</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="line-743">
</span><span id="line-744">        <span class="k">if</span> <span class="n">stop_reason</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-745">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No stop reason found&quot;</span><span class="p">)</span>
</span><span id="line-746">
</span><span id="line-747">        <span class="n">content</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">FunctionCall</span><span class="p">]]</span>
</span><span id="line-748">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">content_deltas</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="line-749">            <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">content_deltas</span><span class="p">)</span>
</span><span id="line-750">            <span class="k">if</span> <span class="n">chunk</span> <span class="ow">and</span> <span class="n">chunk</span><span class="o">.</span><span class="n">usage</span><span class="p">:</span>
</span><span id="line-751">                <span class="n">completion_tokens</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="n">completion_tokens</span>
</span><span id="line-752">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-753">                <span class="n">completion_tokens</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="line-754">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-755">            <span class="n">completion_tokens</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="line-756">            <span class="c1"># TODO: fix assumption that dict values were added in order and actually order by int index</span>
</span><span id="line-757">            <span class="c1"># for tool_call in full_tool_calls.values():</span>
</span><span id="line-758">            <span class="c1">#     # value = json.dumps(tool_call)</span>
</span><span id="line-759">            <span class="c1">#     # completion_tokens += count_token(value, model=model)</span>
</span><span id="line-760">            <span class="c1">#     completion_tokens += 0</span>
</span><span id="line-761">            <span class="n">content</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">full_tool_calls</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="line-762">
</span><span id="line-763">        <span class="n">usage</span> <span class="o">=</span> <span class="n">RequestUsage</span><span class="p">(</span>
</span><span id="line-764">            <span class="n">prompt_tokens</span><span class="o">=</span><span class="n">prompt_tokens</span><span class="p">,</span>
</span><span id="line-765">            <span class="n">completion_tokens</span><span class="o">=</span><span class="n">completion_tokens</span><span class="p">,</span>
</span><span id="line-766">        <span class="p">)</span>
</span><span id="line-767">        <span class="k">if</span> <span class="n">stop_reason</span> <span class="o">==</span> <span class="s2">&quot;function_call&quot;</span><span class="p">:</span>
</span><span id="line-768">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Function calls are not supported in this context&quot;</span><span class="p">)</span>
</span><span id="line-769">        <span class="k">if</span> <span class="n">stop_reason</span> <span class="o">==</span> <span class="s2">&quot;tool_calls&quot;</span><span class="p">:</span>
</span><span id="line-770">            <span class="n">stop_reason</span> <span class="o">=</span> <span class="s2">&quot;function_calls&quot;</span>
</span><span id="line-771">
</span><span id="line-772">        <span class="n">result</span> <span class="o">=</span> <span class="n">CreateResult</span><span class="p">(</span>
</span><span id="line-773">            <span class="n">finish_reason</span><span class="o">=</span><span class="n">stop_reason</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
</span><span id="line-774">            <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
</span><span id="line-775">            <span class="n">usage</span><span class="o">=</span><span class="n">usage</span><span class="p">,</span>
</span><span id="line-776">            <span class="n">cached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="line-777">            <span class="n">logprobs</span><span class="o">=</span><span class="n">logprobs</span><span class="p">,</span>
</span><span id="line-778">        <span class="p">)</span>
</span><span id="line-779">
</span><span id="line-780">        <span class="n">_add_usage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_actual_usage</span><span class="p">,</span> <span class="n">usage</span><span class="p">)</span>
</span><span id="line-781">        <span class="n">_add_usage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_total_usage</span><span class="p">,</span> <span class="n">usage</span><span class="p">)</span>
</span><span id="line-782">
</span><span id="line-783">        <span class="k">yield</span> <span class="n">result</span>
</span><span id="line-784">
</span><span id="line-785">    <span class="k">def</span> <span class="nf">actual_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RequestUsage</span><span class="p">:</span>
</span><span id="line-786">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_actual_usage</span>
</span><span id="line-787">
</span><span id="line-788">    <span class="k">def</span> <span class="nf">total_usage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RequestUsage</span><span class="p">:</span>
</span><span id="line-789">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_usage</span>
</span><span id="line-790">
</span><span id="line-791">    <span class="k">def</span> <span class="nf">count_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">LLMMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tool</span> <span class="o">|</span> <span class="n">ToolSchema</span><span class="p">]</span> <span class="o">=</span> <span class="p">[])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="line-792">        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_args</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>
</span><span id="line-793">        <span class="k">try</span><span class="p">:</span>
</span><span id="line-794">            <span class="n">encoding</span> <span class="o">=</span> <span class="n">tiktoken</span><span class="o">.</span><span class="n">encoding_for_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</span><span id="line-795">        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span id="line-796">            <span class="n">trace_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2"> not found. Using cl100k_base encoding.&quot;</span><span class="p">)</span>
</span><span id="line-797">            <span class="n">encoding</span> <span class="o">=</span> <span class="n">tiktoken</span><span class="o">.</span><span class="n">get_encoding</span><span class="p">(</span><span class="s2">&quot;cl100k_base&quot;</span><span class="p">)</span>
</span><span id="line-798">        <span class="n">tokens_per_message</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="line-799">        <span class="n">tokens_per_name</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="line-800">        <span class="n">num_tokens</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="line-801">
</span><span id="line-802">        <span class="c1"># Message tokens.</span>
</span><span id="line-803">        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
</span><span id="line-804">            <span class="n">num_tokens</span> <span class="o">+=</span> <span class="n">tokens_per_message</span>
</span><span id="line-805">            <span class="n">oai_message</span> <span class="o">=</span> <span class="n">to_oai_type</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span id="line-806">            <span class="k">for</span> <span class="n">oai_message_part</span> <span class="ow">in</span> <span class="n">oai_message</span><span class="p">:</span>
</span><span id="line-807">                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">oai_message_part</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="line-808">                    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-809">                        <span class="k">continue</span>
</span><span id="line-810">
</span><span id="line-811">                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">UserMessage</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="line-812">                        <span class="n">typed_message_value</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">ChatCompletionContentPartParam</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>
</span><span id="line-813">
</span><span id="line-814">                        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">typed_message_value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span>
</span><span id="line-815">                            <span class="n">message</span><span class="o">.</span><span class="n">content</span>
</span><span id="line-816">                        <span class="p">),</span> <span class="s2">&quot;Mismatch in message content and typed message value&quot;</span>
</span><span id="line-817">
</span><span id="line-818">                        <span class="c1"># We need image properties that are only in the original message</span>
</span><span id="line-819">                        <span class="k">for</span> <span class="n">part</span><span class="p">,</span> <span class="n">content_part</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">typed_message_value</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="line-820">                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">content_part</span><span class="p">,</span> <span class="n">Image</span><span class="p">):</span>
</span><span id="line-821">                                <span class="c1"># TODO: add detail parameter</span>
</span><span id="line-822">                                <span class="n">num_tokens</span> <span class="o">+=</span> <span class="n">calculate_vision_tokens</span><span class="p">(</span><span class="n">content_part</span><span class="p">)</span>
</span><span id="line-823">                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="line-824">                                <span class="n">num_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">part</span><span class="p">))</span>
</span><span id="line-825">                            <span class="k">else</span><span class="p">:</span>
</span><span id="line-826">                                <span class="k">try</span><span class="p">:</span>
</span><span id="line-827">                                    <span class="n">serialized_part</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
</span><span id="line-828">                                    <span class="n">num_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">serialized_part</span><span class="p">))</span>
</span><span id="line-829">                                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
</span><span id="line-830">                                    <span class="n">trace_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not convert </span><span class="si">{</span><span class="n">part</span><span class="si">}</span><span class="s2"> to string, skipping.&quot;</span><span class="p">)</span>
</span><span id="line-831">                    <span class="k">else</span><span class="p">:</span>
</span><span id="line-832">                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="line-833">                            <span class="k">try</span><span class="p">:</span>
</span><span id="line-834">                                <span class="n">value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span id="line-835">                            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
</span><span id="line-836">                                <span class="n">trace_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not convert </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> to string, skipping.&quot;</span><span class="p">)</span>
</span><span id="line-837">                                <span class="k">continue</span>
</span><span id="line-838">                        <span class="n">num_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
</span><span id="line-839">                        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span>
</span><span id="line-840">                            <span class="n">num_tokens</span> <span class="o">+=</span> <span class="n">tokens_per_name</span>
</span><span id="line-841">        <span class="n">num_tokens</span> <span class="o">+=</span> <span class="mi">3</span>  <span class="c1"># every reply is primed with &lt;|start|&gt;assistant&lt;|message|&gt;</span>
</span><span id="line-842">
</span><span id="line-843">        <span class="c1"># Tool tokens.</span>
</span><span id="line-844">        <span class="n">oai_tools</span> <span class="o">=</span> <span class="n">convert_tools</span><span class="p">(</span><span class="n">tools</span><span class="p">)</span>
</span><span id="line-845">        <span class="k">for</span> <span class="n">tool</span> <span class="ow">in</span> <span class="n">oai_tools</span><span class="p">:</span>
</span><span id="line-846">            <span class="n">function</span> <span class="o">=</span> <span class="n">tool</span><span class="p">[</span><span class="s2">&quot;function&quot;</span><span class="p">]</span>
</span><span id="line-847">            <span class="n">tool_tokens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">function</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]))</span>
</span><span id="line-848">            <span class="k">if</span> <span class="s2">&quot;description&quot;</span> <span class="ow">in</span> <span class="n">function</span><span class="p">:</span>
</span><span id="line-849">                <span class="n">tool_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">function</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]))</span>
</span><span id="line-850">            <span class="n">tool_tokens</span> <span class="o">-=</span> <span class="mi">2</span>
</span><span id="line-851">            <span class="k">if</span> <span class="s2">&quot;parameters&quot;</span> <span class="ow">in</span> <span class="n">function</span><span class="p">:</span>
</span><span id="line-852">                <span class="n">parameters</span> <span class="o">=</span> <span class="n">function</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span>
</span><span id="line-853">                <span class="k">if</span> <span class="s2">&quot;properties&quot;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
</span><span id="line-854">                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span>
</span><span id="line-855">                    <span class="k">for</span> <span class="n">propertiesKey</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]:</span>  <span class="c1"># pyright: ignore</span>
</span><span id="line-856">                        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">propertiesKey</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
</span><span id="line-857">                        <span class="n">tool_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">propertiesKey</span><span class="p">))</span>
</span><span id="line-858">                        <span class="n">v</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="n">propertiesKey</span><span class="p">]</span>  <span class="c1"># pyright: ignore</span>
</span><span id="line-859">                        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>  <span class="c1"># pyright: ignore</span>
</span><span id="line-860">                            <span class="k">if</span> <span class="n">field</span> <span class="o">==</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span>
</span><span id="line-861">                                <span class="n">tool_tokens</span> <span class="o">+=</span> <span class="mi">2</span>
</span><span id="line-862">                                <span class="n">tool_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]))</span>  <span class="c1"># pyright: ignore</span>
</span><span id="line-863">                            <span class="k">elif</span> <span class="n">field</span> <span class="o">==</span> <span class="s2">&quot;description&quot;</span><span class="p">:</span>
</span><span id="line-864">                                <span class="n">tool_tokens</span> <span class="o">+=</span> <span class="mi">2</span>
</span><span id="line-865">                                <span class="n">tool_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]))</span>  <span class="c1"># pyright: ignore</span>
</span><span id="line-866">                            <span class="k">elif</span> <span class="n">field</span> <span class="o">==</span> <span class="s2">&quot;enum&quot;</span><span class="p">:</span>
</span><span id="line-867">                                <span class="n">tool_tokens</span> <span class="o">-=</span> <span class="mi">3</span>
</span><span id="line-868">                                <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;enum&quot;</span><span class="p">]:</span>  <span class="c1"># pyright: ignore</span>
</span><span id="line-869">                                    <span class="n">tool_tokens</span> <span class="o">+=</span> <span class="mi">3</span>
</span><span id="line-870">                                    <span class="n">tool_tokens</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoding</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">o</span><span class="p">))</span>  <span class="c1"># pyright: ignore</span>
</span><span id="line-871">                            <span class="k">else</span><span class="p">:</span>
</span><span id="line-872">                                <span class="n">trace_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not supported field </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="line-873">                    <span class="n">tool_tokens</span> <span class="o">+=</span> <span class="mi">11</span>
</span><span id="line-874">                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># pyright: ignore</span>
</span><span id="line-875">                        <span class="n">tool_tokens</span> <span class="o">-=</span> <span class="mi">2</span>
</span><span id="line-876">            <span class="n">num_tokens</span> <span class="o">+=</span> <span class="n">tool_tokens</span>
</span><span id="line-877">        <span class="n">num_tokens</span> <span class="o">+=</span> <span class="mi">12</span>
</span><span id="line-878">        <span class="k">return</span> <span class="n">num_tokens</span>
</span><span id="line-879">
</span><span id="line-880">    <span class="k">def</span> <span class="nf">remaining_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">messages</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">LLMMessage</span><span class="p">],</span> <span class="n">tools</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Tool</span> <span class="o">|</span> <span class="n">ToolSchema</span><span class="p">]</span> <span class="o">=</span> <span class="p">[])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="line-881">        <span class="n">token_limit</span> <span class="o">=</span> <span class="n">_model_info</span><span class="o">.</span><span class="n">get_token_limit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_args</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">])</span>
</span><span id="line-882">        <span class="k">return</span> <span class="n">token_limit</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">count_tokens</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">)</span>
</span><span id="line-883">
</span><span id="line-884">    <span class="nd">@property</span>
</span><span id="line-885">    <span class="k">def</span> <span class="nf">capabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ModelCapabilities</span><span class="p">:</span>
</span><span id="line-886">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_capabilities</span>
</span><span id="line-887">
</span><span id="line-888">
<div class="viewcode-block" id="OpenAIChatCompletionClient">
<a class="viewcode-back" href="../../../../reference/python/autogen_ext/autogen_ext.models.html#autogen_ext.models.OpenAIChatCompletionClient">[docs]</a>
</span><span id="line-889"><span class="k">class</span> <span class="nc">OpenAIChatCompletionClient</span><span class="p">(</span><span class="n">BaseOpenAIChatCompletionClient</span><span class="p">):</span>
</span><span id="line-890"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Chat completion client for OpenAI hosted models.</span>
</span><span id="line-891">
</span><span id="line-892"><span class="sd">    You can also use this client for OpenAI-compatible ChatCompletion endpoints.</span>
</span><span id="line-893"><span class="sd">    **Using this client for non-OpenAI models is not tested or guaranteed.**</span>
</span><span id="line-894">
</span><span id="line-895"><span class="sd">    For non-OpenAI models, please first take a look at our `community extensions &lt;https://microsoft.github.io/autogen/dev/user-guide/extensions-user-guide/index.html&gt;`_</span>
</span><span id="line-896"><span class="sd">    for additional model clients.</span>
</span><span id="line-897">
</span><span id="line-898"><span class="sd">    Args:</span>
</span><span id="line-899"><span class="sd">        model (str): The model to use. **Required.**</span>
</span><span id="line-900"><span class="sd">        api_key (str): The API key to use. **Required if &#39;OPENAI_API_KEY&#39; is not found in the environment variables.**</span>
</span><span id="line-901"><span class="sd">        timeout (optional, int): The timeout for the request in seconds.</span>
</span><span id="line-902"><span class="sd">        max_retries (optional, int): The maximum number of retries to attempt.</span>
</span><span id="line-903"><span class="sd">        organization_id (optional, str): The organization ID to use.</span>
</span><span id="line-904"><span class="sd">        base_url (optional, str): The base URL to use. **Required if the model is not hosted on OpenAI.**</span>
</span><span id="line-905"><span class="sd">        model_capabilities (optional, ModelCapabilities): The capabilities of the model. **Required if the model name is not a valid OpenAI model.**</span>
</span><span id="line-906">
</span><span id="line-907"><span class="sd">    To use this client, you must install the `openai` extension:</span>
</span><span id="line-908">
</span><span id="line-909"><span class="sd">        .. code-block:: bash</span>
</span><span id="line-910">
</span><span id="line-911"><span class="sd">            pip install &#39;autogen-ext[openai]==0.4.0.dev8&#39;</span>
</span><span id="line-912">
</span><span id="line-913"><span class="sd">    The following code snippet shows how to use the client with an OpenAI model:</span>
</span><span id="line-914">
</span><span id="line-915"><span class="sd">        .. code-block:: python</span>
</span><span id="line-916">
</span><span id="line-917"><span class="sd">            from autogen_ext.models import OpenAIChatCompletionClient</span>
</span><span id="line-918"><span class="sd">            from autogen_core.components.models import UserMessage</span>
</span><span id="line-919">
</span><span id="line-920"><span class="sd">            openai_client = OpenAIChatCompletionClient(</span>
</span><span id="line-921"><span class="sd">                model=&quot;gpt-4o-2024-08-06&quot;,</span>
</span><span id="line-922"><span class="sd">                # api_key=&quot;sk-...&quot;, # Optional if you have an OPENAI_API_KEY environment variable set.</span>
</span><span id="line-923"><span class="sd">            )</span>
</span><span id="line-924">
</span><span id="line-925"><span class="sd">            result = await openai_client.create([UserMessage(content=&quot;What is the capital of France?&quot;, source=&quot;user&quot;)])  # type: ignore</span>
</span><span id="line-926"><span class="sd">            print(result)</span>
</span><span id="line-927">
</span><span id="line-928">
</span><span id="line-929"><span class="sd">    To use the client with a non-OpenAI model, you need to provide the base URL of the model and the model capabilities:</span>
</span><span id="line-930">
</span><span id="line-931"><span class="sd">        .. code-block:: python</span>
</span><span id="line-932">
</span><span id="line-933"><span class="sd">            from autogen_ext.models import OpenAIChatCompletionClient</span>
</span><span id="line-934">
</span><span id="line-935"><span class="sd">            custom_model_client = OpenAIChatCompletionClient(</span>
</span><span id="line-936"><span class="sd">                model=&quot;custom-model-name&quot;,</span>
</span><span id="line-937"><span class="sd">                base_url=&quot;https://custom-model.com/reset/of/the/path&quot;,</span>
</span><span id="line-938"><span class="sd">                api_key=&quot;placeholder&quot;,</span>
</span><span id="line-939"><span class="sd">                model_capabilities={</span>
</span><span id="line-940"><span class="sd">                    &quot;vision&quot;: True,</span>
</span><span id="line-941"><span class="sd">                    &quot;function_calling&quot;: True,</span>
</span><span id="line-942"><span class="sd">                    &quot;json_output&quot;: True,</span>
</span><span id="line-943"><span class="sd">                },</span>
</span><span id="line-944"><span class="sd">            )</span>
</span><span id="line-945">
</span><span id="line-946"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="line-947">
</span><span id="line-948">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Unpack</span><span class="p">[</span><span class="n">OpenAIClientConfiguration</span><span class="p">]):</span>
</span><span id="line-949">        <span class="k">if</span> <span class="s2">&quot;model&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="line-950">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;model is required for OpenAIChatCompletionClient&quot;</span><span class="p">)</span>
</span><span id="line-951">
</span><span id="line-952">        <span class="n">model_capabilities</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ModelCapabilities</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="line-953">        <span class="n">copied_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="line-954">        <span class="k">if</span> <span class="s2">&quot;model_capabilities&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="line-955">            <span class="n">model_capabilities</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;model_capabilities&quot;</span><span class="p">]</span>
</span><span id="line-956">            <span class="k">del</span> <span class="n">copied_args</span><span class="p">[</span><span class="s2">&quot;model_capabilities&quot;</span><span class="p">]</span>
</span><span id="line-957">
</span><span id="line-958">        <span class="n">client</span> <span class="o">=</span> <span class="n">_openai_client_from_config</span><span class="p">(</span><span class="n">copied_args</span><span class="p">)</span>
</span><span id="line-959">        <span class="n">create_args</span> <span class="o">=</span> <span class="n">_create_args_from_config</span><span class="p">(</span><span class="n">copied_args</span><span class="p">)</span>
</span><span id="line-960">        <span class="bp">self</span><span class="o">.</span><span class="n">_raw_config</span> <span class="o">=</span> <span class="n">copied_args</span>
</span><span id="line-961">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">create_args</span><span class="p">,</span> <span class="n">model_capabilities</span><span class="p">)</span>
</span><span id="line-962">
</span><span id="line-963">    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="line-964">        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="line-965">        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;_client&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="line-966">        <span class="k">return</span> <span class="n">state</span>
</span><span id="line-967">
</span><span id="line-968">    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-969">        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="line-970">        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">_openai_client_from_config</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;_raw_config&quot;</span><span class="p">])</span></div>

</span><span id="line-971">
</span><span id="line-972">
<div class="viewcode-block" id="AzureOpenAIChatCompletionClient">
<a class="viewcode-back" href="../../../../reference/python/autogen_ext/autogen_ext.models.html#autogen_ext.models.AzureOpenAIChatCompletionClient">[docs]</a>
</span><span id="line-973"><span class="k">class</span> <span class="nc">AzureOpenAIChatCompletionClient</span><span class="p">(</span><span class="n">BaseOpenAIChatCompletionClient</span><span class="p">):</span>
</span><span id="line-974"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Chat completion client for Azure OpenAI hosted models.</span>
</span><span id="line-975">
</span><span id="line-976"><span class="sd">    Args:</span>
</span><span id="line-977"><span class="sd">        azure_endpoint (str): The endpoint for the Azure model. **Required for Azure models.**</span>
</span><span id="line-978"><span class="sd">        model (str): The deployment ID for the Azure model. **Required for Azure models.**</span>
</span><span id="line-979"><span class="sd">        api_version (str): The API version to use. **Required for Azure models.**</span>
</span><span id="line-980"><span class="sd">        azure_ad_token (str): The Azure AD token to use. Provide this or `azure_ad_token_provider` for token-based authentication.</span>
</span><span id="line-981"><span class="sd">        azure_ad_token_provider (Callable[[], Awaitable[str]]): The Azure AD token provider to use. Provide this or `azure_ad_token` for token-based authentication.</span>
</span><span id="line-982"><span class="sd">        model_capabilities (ModelCapabilities): The capabilities of the model if default resolved values are not correct.</span>
</span><span id="line-983"><span class="sd">        api_key (optional, str): The API key to use, use this if you are using key based authentication. It is optional if you are using Azure AD token based authentication or `AZURE_OPENAI_API_KEY` environment variable.</span>
</span><span id="line-984"><span class="sd">        timeout (optional, int): The timeout for the request in seconds.</span>
</span><span id="line-985"><span class="sd">        max_retries (optional, int): The maximum number of retries to attempt.</span>
</span><span id="line-986">
</span><span id="line-987"><span class="sd">    To use this client, you must install the `azure` and `openai` extensions:</span>
</span><span id="line-988">
</span><span id="line-989"><span class="sd">        .. code-block:: bash</span>
</span><span id="line-990">
</span><span id="line-991"><span class="sd">            pip install &#39;autogen-ext[openai,azure]==0.4.0.dev8&#39;</span>
</span><span id="line-992">
</span><span id="line-993"><span class="sd">    To use the client, you need to provide your deployment id, Azure Cognitive Services endpoint,</span>
</span><span id="line-994"><span class="sd">    api version, and model capabilities.</span>
</span><span id="line-995"><span class="sd">    For authentication, you can either provide an API key or an Azure Active Directory (AAD) token credential.</span>
</span><span id="line-996">
</span><span id="line-997"><span class="sd">    The following code snippet shows how to use AAD authentication.</span>
</span><span id="line-998"><span class="sd">    The identity used must be assigned the `Cognitive Services OpenAI User &lt;https://learn.microsoft.com/en-us/azure/ai-services/openai/how-to/role-based-access-control#cognitive-services-openai-user&gt;`_ role.</span>
</span><span id="line-999">
</span><span id="line-1000"><span class="sd">        .. code-block:: python</span>
</span><span id="line-1001">
</span><span id="line-1002"><span class="sd">            from autogen_ext.models import AzureOpenAIChatCompletionClient</span>
</span><span id="line-1003"><span class="sd">            from azure.identity import DefaultAzureCredential, get_bearer_token_provider</span>
</span><span id="line-1004">
</span><span id="line-1005"><span class="sd">            # Create the token provider</span>
</span><span id="line-1006"><span class="sd">            token_provider = get_bearer_token_provider(DefaultAzureCredential(), &quot;https://cognitiveservices.azure.com/.default&quot;)</span>
</span><span id="line-1007">
</span><span id="line-1008"><span class="sd">            az_model_client = AzureOpenAIChatCompletionClient(</span>
</span><span id="line-1009"><span class="sd">                azure_deployment=&quot;{your-azure-deployment}&quot;,</span>
</span><span id="line-1010"><span class="sd">                model=&quot;{deployed-model, such as &#39;gpt-4o&#39;}&quot;,</span>
</span><span id="line-1011"><span class="sd">                api_version=&quot;2024-06-01&quot;,</span>
</span><span id="line-1012"><span class="sd">                azure_endpoint=&quot;https://{your-custom-endpoint}.openai.azure.com/&quot;,</span>
</span><span id="line-1013"><span class="sd">                azure_ad_token_provider=token_provider,  # Optional if you choose key-based authentication.</span>
</span><span id="line-1014"><span class="sd">                # api_key=&quot;sk-...&quot;, # For key-based authentication. `AZURE_OPENAI_API_KEY` environment variable can also be used instead.</span>
</span><span id="line-1015"><span class="sd">            )</span>
</span><span id="line-1016">
</span><span id="line-1017"><span class="sd">    See `here &lt;https://learn.microsoft.com/en-us/azure/ai-services/openai/how-to/managed-identity#chat-completions&gt;`_ for how to use the Azure client directly or for more info.</span>
</span><span id="line-1018">
</span><span id="line-1019"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="line-1020">
</span><span id="line-1021">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Unpack</span><span class="p">[</span><span class="n">AzureOpenAIClientConfiguration</span><span class="p">]):</span>
</span><span id="line-1022">        <span class="n">model_capabilities</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ModelCapabilities</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="line-1023">        <span class="n">copied_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="line-1024">        <span class="k">if</span> <span class="s2">&quot;model_capabilities&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="line-1025">            <span class="n">model_capabilities</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;model_capabilities&quot;</span><span class="p">]</span>
</span><span id="line-1026">            <span class="k">del</span> <span class="n">copied_args</span><span class="p">[</span><span class="s2">&quot;model_capabilities&quot;</span><span class="p">]</span>
</span><span id="line-1027">
</span><span id="line-1028">        <span class="n">client</span> <span class="o">=</span> <span class="n">_azure_openai_client_from_config</span><span class="p">(</span><span class="n">copied_args</span><span class="p">)</span>
</span><span id="line-1029">        <span class="n">create_args</span> <span class="o">=</span> <span class="n">_create_args_from_config</span><span class="p">(</span><span class="n">copied_args</span><span class="p">)</span>
</span><span id="line-1030">        <span class="bp">self</span><span class="o">.</span><span class="n">_raw_config</span> <span class="o">=</span> <span class="n">copied_args</span>
</span><span id="line-1031">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">create_args</span><span class="p">,</span> <span class="n">model_capabilities</span><span class="p">)</span>
</span><span id="line-1032">
</span><span id="line-1033">    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="line-1034">        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="line-1035">        <span class="n">state</span><span class="p">[</span><span class="s2">&quot;_client&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="line-1036">        <span class="k">return</span> <span class="n">state</span>
</span><span id="line-1037">
</span><span id="line-1038">    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-1039">        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span id="line-1040">        <span class="bp">self</span><span class="o">.</span><span class="n">_client</span> <span class="o">=</span> <span class="n">_azure_openai_client_from_config</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;_raw_config&quot;</span><span class="p">])</span></div>

</span></code></pre></div>
    </div></div>
          
        </main>
      </div>
    </div><footer class="py-6 border-t border-border md:py-0">
    <div class="container flex flex-col items-center justify-between gap-4 md:h-24 md:flex-row">
      <div class="flex flex-col items-center gap-4 px-8 md:flex-row md:gap-2 md:px-0">
        <p class="text-sm leading-loose text-center text-muted-foreground md:text-left">Â© 2024, Microsoft&nbsp;. Built with <a class="font-medium underline underline-offset-4"
    href="https://www.sphinx-doc.org"
    rel="noreferrer">Sphinx 8.1.3</a><ul class="list-unstyled text-sm leading-loose text-right text-muted-foreground md:text-right">
        <li>  |  <a class="  underline underline-offset-4" href="https://go.microsoft.com/fwlink/?LinkId=521839">Privacy Policy</a> | <a class="  underline underline-offset-4"   href="https://go.microsoft.com/fwlink/?linkid=2259814">Consumer Health Privacy</a> </li>

      </ul></p>
</div>
</div>
</footer>
  </div>
  
    <script src="../../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script defer="defer" src="../../../../_static/theme.js?v=073f68d9"></script>
    <script src="../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script></script>
  
</body>
</html>